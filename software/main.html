<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
    <!--RUN FULL SCREEN-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#2A3F54">

  <title>Skywalk Flightplan</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://pyscript.net/releases/2025.8.1/core.css">
  <script type="module" src="https://pyscript.net/releases/2025.8.1/core.js"></script>
</head>

<body>
  <div id="app">
    <div id="loading-spinner" class="spinner-overlay" style="display: flex;">
      <div class="spinner-container">
        <div class="spinner"></div>
        <div class="spinner-text">Loading SkyWalk. Please wait..</div>
      </div>
    </div>

    <!-- Tab links -->
    <div class="tab">
      <button class="tablinks active" data-tab="General">Start</button>
      <button class="tablinks" data-tab="Departure">Departure</button>
      <button class="tablinks" data-tab="Arrival">Arrival</button>
      <button class="tablinks" data-tab="Enroute">Enroute</button>
      <button class="tablinks" data-tab="ATC">ATC</button>
      <button class="tablinks" data-tab="Config">‚öôÔ∏è</button>
    </div>

    <!-- Tab contents -->


    <!-- =============== TAB GENERAL =============== -->

	<div id="General" class="tabcontent" style="display:block;">
	  <!-- Logo -->
	  <div class="logo-container">
		<a href="https://erdogant.github.io/skywalk-docs/pages/html/index.html" target="_blank">
		  <img id="skywalk_logo" alt="SkyWalk">
		</a>
		<div class="version" style="margin-bottom: 5px; ">version: 1.0.0</div>
	  </div>

	  <label_h1>Flightplan</label_h1>
	  <!-- New Flightplan row -->

	  <!-- Flightplan select + Load row -->
	  <div class="button-row">
			<button id="new_plan_btn">New Flightplan</button>
		<select id="plan_spinner" onchange="this.value && window.load_flightplan()">
		  <option value="">Load Flightplan</option>
		</select>
		<button id="delete_btn" style="background-color: transparent; border: none; color: #666; cursor: grab; width: 30px; min-width: 24px; height: 24px; padding: 0; margin: 8px 0 8px 4px; flex: 0 0 auto;">üóëÔ∏è</button>
	  </div>

	  <!-- Flightplan Name row -->
	  <div class="button-row">
		<input type="text" id="FLIGHTPLAN" placeholder="Flightplan Name">
	  </div>

	  <!-- Aircraft Info Label -->
	  <label_h1>Aircraft Info</label_h1>

	  <!-- CALLSIGN + Aircraft Type row -->
	  <div class="button-row">
        <input type="text" id="CALLSIGN" class="UPPERCASE_input" placeholder="CALLSIGN (PH-SVU)">
        <input type="text" id="AIRCRAFT_TYPE" class="UPPERCASE_input" placeholder="Aircraft Type (Robin400)">
    </div>

	  <!-- Persons on Board + Flight Rules row -->
	  <div class="button-row">
		<input type="text" id="POB" placeholder="Persons on Board">
		<select id="FLIGHT_RULES_spinner">
		  <option value="VFR">VFR</option>
		  <option value="IFR">IFR</option>
		</select>
	  </div>

	<!-- Datetime row -->
	<div class="button-row">
		<input type="text" id="DATETIME" placeholder="dd-mm-yyyy hh:mm">
		<button id="set_datetime_btn">Now</button>
			</div>

	  <!-- Save + Bottom Buttons Container -->
	  <div id="bottom-container">
    	  <!-- Logo -->
    	  <div class="coffee-container">
    		<a href="https://www.buymeacoffee.com/erdogant" target="_blank">
    		  <img id="coffee_image" alt="Coffee Donation">
    		</a>
           	<center>
          		<script async src="https://media.ethicalads.io/media/client/ethicalads.min.js"></script>
          		<div data-ea-publisher="erdogantgithubio" data-ea-type="text"></div>
           	</center>
    	  </div>

	  </div>

	</div>


	<!-- ============================================= -->
	<!-- =============== TAB DEPARTURE =============== -->
	<!-- ============================================= -->

	<div id="Departure" class="tabcontent">

	  <!-- Departure Information Label -->
	  <label_h1>Departure Information</label_h1>

	  <!-- Line 2: COUNTRY and ICAO_CITY spinners aligned -->
	  <div class="button-row">
		<select id="DEPARTURE_COUNTRY">
			<option value=""></option>
		</select>
		<select id="DEPARTURE_ICAO_CITY">
		  <option value=""></option>
		  <!-- ICAO City options will be populated dynamically -->
		</select>
	  </div>

	  <!-- Line 4: NAME and ICAO inputs -->
	  <div class="button-row">
		<input type="text" id="DEPARTURE_NAME" placeholder="Airport Name">
		<input type="text" id="DEPARTURE_ICAO" class="UPPERCASE_input" placeholder="ICAO">
	  </div>

	  <!-- Line 5: POSITION, RUNWAY, ELEVATION inputs -->
	  <div class="button-row">
		<input type="text" id="DEPARTURE_POSITION" placeholder="Position (At the Apron)", class="UPPERCASE_input">
		<select id="DEPARTURE_CTR" onchange="updateMissingFields()">
		  <option value=""></option>
		  <option value="CTR">CTR</option>
		</select>

	  </div>

	  <div class="button-row">
		<input type="text" id="DEPARTURE_RUNWAY" placeholder="Runway Number">
		<input type="text" id="DEPARTURE_ELEVATION" placeholder="Field Elevation (ft)">
	  </div>

	  <!-- Line 6: ROUTE_NAME, ROUTE_ALTITUDE, CIRCUIT_ALTITUDE inputs -->
	  <div class="button-row">
		<input type="text" id="DEPARTURE_ROUTE_NAME" placeholder="Route Name", class="UPPERCASE_input">
		<input type="text" id="DEPARTURE_ROUTE_ALTITUDE" placeholder="Route Altitude">
		<input type="text" id="DEPARTURE_CIRCUIT_ALTITUDE" placeholder="Circuit Altitude">
	  </div>

	  <!-- Line 7: Frequency label -->
	  <label_h1>Frequency</label_h1>

	  <!-- Line 8: ATC_TOWER and ATC_APPROACH inputs -->
	  <div class="button-row">
		<input type="text" id="DEPARTURE_ATC_TOWER" placeholder="Tower Frequency">
		<input type="text" id="DEPARTURE_ATC_APPROACH" placeholder="Approach Frequency">
	  </div>

	  <!-- Line 9: ATC_ATIS_FREQ and ATC_GROUND inputs -->
	  <div class="button-row">
		<input type="text" id="DEPARTURE_ATC_ATIS_FREQ" placeholder="ATIS Frequency">
		<input type="text" id="DEPARTURE_ATC_GROUND" placeholder="Ground Frequency">
	  </div>

	  <!-- Line 10: ATC_TELEPHONE input -->
	  <div class="button-row">
		<input type="text" id="DEPARTURE_ATC_TELEPHONE" placeholder="Telephone">
	  </div>

	  <!-- Departure Image -->
	  <div class="logo-container" style="margin-top: 20px;">
		<img id="DEPARTURE_image_cache" alt="Departure Aerodrome" style="max-width: 100%; height: auto; border-radius: 10px;">
	  </div>

	  <!--<div class="button-row">
		<button id="retrieve_metar_btn">Update METAR/ TAF</button>
	  </div>-->

    <div class="button-row">
        <button id="metar-taf-embed-departure" style="transition: background-color 0.3s">Refresh METAR-TAF</button>
    </div>
    <div class="button-row">
        <input type="text" id="datetime-metar-taf-departure" placeholder="Date and Time for METAR" style="transition: background-color 0.3s">
    </div>

    <div id="departureWidgetContainer"></div>


    </div>


    <!-- ============================================= -->
	<!-- =============== TAB ARRIVAL =============== -->
	<!-- ============================================= -->

	<div id="Arrival" class="tabcontent">

        <!-- Arrival Information Label -->
        <label_h1>Arrival Information</label_h1>

        <!-- Line 2: COUNTRY and ICAO_CITY spinners aligned -->
        <div class="button-row">
            <select id="ARRIVAL_COUNTRY">
                <option value=""></option>
            </select>
            <select id="ARRIVAL_ICAO_CITY" onchange="preserveFormFields()" onfocus="preserveFormFields()">
                <option value=""></option>
                <!-- ICAO City options will be populated dynamically -->
                </select>
        </div>

        <!-- Line 4: NAME and ICAO inputs -->
        <div class="button-row">
            <input type="text" id="ARRIVAL_NAME" placeholder="Airport Name">
            <input type="text" id="ARRIVAL_ICAO" class="UPPERCASE_input" placeholder="ICAO">
        </div>

        <!-- Line 5: POSITION, RUNWAY, ELEVATION inputs -->
        <div class="button-row">
            <input type="text" id="ARRIVAL_POSITION" placeholder="Position (At the Apron)", class="UPPERCASE_input">
            <select id="ARRIVAL_CTR" onchange="updateMissingFields()">
        <option value=""></option>
        <option value="CTR">CTR</option>
        </select>

        </div>

        <div class="button-row">
            <input type="text" id="ARRIVAL_RUNWAY" placeholder="Runway Number">
            <input type="text" id="ARRIVAL_ELEVATION" placeholder="Field Elevation (ft)">
        </div>

        <!-- Line 6: ROUTE_NAME, ROUTE_ALTITUDE, CIRCUIT_ALTITUDE inputs -->
        <div class="button-row">
            <input type="text" id="ARRIVAL_ROUTE_NAME" placeholder="Route Name", class="UPPERCASE_input">
            <input type="text" id="ARRIVAL_ROUTE_ALTITUDE" placeholder="Route Altitude">
            <input type="text" id="ARRIVAL_CIRCUIT_ALTITUDE" placeholder="Circuit Altitude">
        </div>

        <!-- Line 7: Frequency label -->
        <label_h1>Frequency</label_h1>

        <!-- Line 8: ATC_TOWER and ATC_APPROACH inputs -->
        <div class="button-row">
            <input type="text" id="ARRIVAL_ATC_TOWER" placeholder="Tower Frequency">
            <input type="text" id="ARRIVAL_ATC_APPROACH" placeholder="Approach Frequency">
        </div>

        <!-- Line 9: ATC_ATIS_FREQ and ATC_GROUND inputs -->
        <div class="button-row">
            <input type="text" id="ARRIVAL_ATC_ATIS_FREQ" placeholder="ATIS Frequency">
            <input type="text" id="ARRIVAL_ATC_GROUND" placeholder="Ground Frequency">
        </div>

        <!-- Line 10: ATC_TELEPHONE input -->
        <div class="button-row">
            <input type="text" id="ARRIVAL_ATC_TELEPHONE" placeholder="Telephone">
        </div>

        <!-- ARRIVAL Image -->
        <div class="logo-container" style="margin-top: 20px;">
            <img id="ARRIVAL_image_cache" alt="Arrival Aerodrome" style="max-width: 100%; height: auto; border-radius: 10px;">
        </div>


        <!--<div class="button-row">
            <button id="retrieve_metar_btn">Update METAR/ TAF</button>
        </div>-->
        <!--<div class="button-row">
            <button id="metar-taf-embed-arrival">Refresh METAR-TAF</button>
        </div>
        <div class="button-row">
            <input type="text" id="datetime-metar-taf-arrival" placeholder="Date and Time">
        </div>-->
        <div class="button-row">
            <button id="metar-taf-embed-arrival" style="transition: background-color 0.3s">Refresh METAR-TAF</button>
        </div>
        <div class="button-row">
            <input type="text" id="datetime-metar-taf-arrival" placeholder="Date and Time" style="transition: background-color 0.3s">
        </div>

        <div id="arrivalWidgetContainer"></div>

    </div>


    <!-- =============== TAB ENROUTE =============== -->

    <div id="Enroute" class="tabcontent">
    <!-- Enroute Information Label -->
	  <label_h1>Enroute Information</label_h1>

    <!-- Line: FIC Name and FIC Frequency labels -->
        <div class="button-row">
          <div style="display:flex; flex-direction:column; flex:1; margin-right:10px;">
            <label for="FIC_NAME">FIC name</label>
          </div>
          <div style="display:flex; flex-direction:column; flex:1;">
            <label for="FIC_FREQUENCY">FIC frequency</label>
          </div>
        </div>

        <!-- Line: FIC Name and FIC Frequency inputs -->
        <div class="button-row">
          <input type="text" id="FIC_NAME" placeholder="FIC Name", class="REPLACE_INFO">
          <input type="text" id="FIC_FREQUENCY" placeholder="FIC Frequency">
        </div>
        <div class="button-row">
          <input type="text" id="OVERHEAD" placeholder="Overhead Point", class="UPPERCASE_input">
          <input type="text" id="SQUAWK" placeholder="SQUAWK">
        </div>

        <!-- Line: SECOND FIC label -->
        <label_h1>SECOND FIC</label_h1>

        <!-- Line: FIC Name2 and FIC Frequency2 inputs -->
        <div class="button-row">
          <input type="text" id="FIC_NAME2" placeholder="FIC Name 2", class="REPLACE_INFO">
          <input type="text" id="FIC_FREQUENCY2" placeholder="FIC Frequency 2">
        </div>
        <div class="button-row">
          <input type="text" id="OVERHEAD2" placeholder="Overhead Point", class="UPPERCASE_input">
          <input type="text" id="SQUAWK2" placeholder="SQUAWK">
        </div>
    </div>


    <!-- =============== TAB ATC =============== -->


    <div id="ATC" class="tabcontent">
        <!-- ATC -->
        <label_h1>Display Settings</label_h1>

        <div style="border: 1px solid lightgrey; border-radius: 10px; padding: 10px;">
            <div class="button-row">
                <div style="display:flex; flex-direction:column; flex:1; margin-right:10px;">
                    <label for="user_usage_type">Choose Output</label>
                    <select id="user_usage_type">
                        <option value="print" selected>Print</option>
                        <option value="view">Screen</option>
                    </select>
                </div>

                <div style="display:flex; flex-direction:column; flex:1;">
                    <label for="user_select_cols">Columns</label>
                    <select id="user_select_cols">
                        <option value="1">1</option>
                        <option value="2" selected>2</option>
                        <option value="3">3</option>
                    </select>
                </div>
            </div>
        </div>

        <label_h1>Required Fields</label_h1>
        <div style="border: 1px solid lightgrey; border-radius: 10px; padding: 10px;">
            <div id="bottom-container">
                <div class="warning" id="missing_label">Missing: Flightplan Name, CALLSIGN, Aircraft Type</div>
            </div>
        </div>


       <label_h1>Air Traffic Control (ATC)</label_h1>

       <div style="border: 1px solid lightgrey; border-radius: 10px; padding: 10px;">
           <div class="button-row">
               <button id="BTN_HTML_SUMMARY">Summary ATC</button>
                <button id="BTN_HTML_SUMMARY_REV">Reverse</button>
            </div>
            <div class="button-row">
                <button id="BTN_HTML_DEPARTURE">Departure ATC</button>
                <button id="BTN_HTML_DEPARTURE_REV">Reverse</button>
            </div>
            <div class="button-row">
                <button id="BTN_HTML_ARRIVAL">Arrival ATC</button>
                <button id="BTN_HTML_ARRIVAL_REV">Reverse</button>
            </div>
            <div class="button-row">
                <button id="BTN_HTML_ENROUTE">Enroute ATC</button>
                <button id="BTN_HTML_EN_REV">Reverse</button>
            </div>
       </div>


        <label_h1>Disclaimer</label_h1>
        <div class="disclaimer" style="margin-bottom: 20px; border: 2px solid red; border-radius: 10px; padding: 10px;">SkyWalk is provided as-is without any warranty or guarantee. SkyWalk is only to be used for educational purposes and not for commercial or professional use. The developers are not responsible for any damages or losses resulting from the use of this app.</div>
        <!--
        <div class="button-row">
            <select id="DEPARTURE_COUNTRY_DEFAULT">
                <option value="">country_select</option>
            </select>
            <select id="ARRIVAL_COUNTRY_DEFAULT">
                <option value="">country_select</option>
            </select>
        </div>
        -->

        <!--
        <div class="button-row">
            <div style="display:flex; flex-direction:column; flex:1; margin-right:10px;">
                <label for="MAX_HEADWIND_LIMIT">Max. Headwind</label>
                <input type="text" id="MAX_HEADWIND_LIMIT" placeholder="Max Headwind Limit">
            </div>
            <div style="display:flex; flex-direction:column; flex:1;">
                <label for="MAX_CROSSWIND_LIMIT">Max. Crosswind</label>
                <input type="text" id="MAX_CROSSWIND_LIMIT" placeholder="Max Crosswind Limit">
            </div>
        </div>
        -->

    </div>

    <!-- =============== TAB CONFIGURATIONS =============== -->

    <div id="Config" class="tabcontent">
        <!-- CONFIGURATIONS -->
        <label_h1>Information</label_h1>
        <div class="info" style="margin-bottom: 20px;">SkyWalk is a web-based tool designed to help pilots communicate effectively with Air Traffic Control (ATC). The app is free for use, is for educational purposes and does not require any registration or login. If you enjoy using SkyWalk, please consider supporting by donating a coffee.</div>

        <label_h1>Cleaning</label_h1>
        <div class="button-row" style="margin-top: 20px;">
            <button id="clear_cache_btn" style="background-color: #ff4444; color: white;">Clear Cache</button>
        </div>
        <div class="warning" style="margin-bottom: 20px;">Warning: This will permanently delete all saved flightplans from your local browser storage. The reason for using this is when you want to start fresh or when you suspect that your flightplans are corrupted or the ATC output does not show or update. This action cannot be undone.</div>

    </div>


<script>
    document.getElementById('set_datetime_btn').addEventListener('click', () => {
      /*Update datetime field to current time.
      Updates the datetime input field with the current date and time in format DD-MM-YYYY HH:MM.
      The button click handler sets the input value to the current timestamp when clicked.
      */
	const now = new Date();
	const day = String(now.getDate()).padStart(2, '0');
	const month = String(now.getMonth() + 1).padStart(2, '0');
	const year = now.getFullYear();
	const hours = String(now.getHours()).padStart(2, '0');
	const minutes = String(now.getMinutes()).padStart(2, '0');
	document.getElementById('DATETIME').value = `${day}-${month}-${year} ${hours}:${minutes}`;
	});
</script>

<script>
    // Store form field values
    let formFields = {};
    let isRestoring = false;

    function preserveFormFields() {
        if (isRestoring) return;
        // Save important form fields
        const fieldsToPreserve = ['DEPARTURE_POSITION', 'DEPARTURE_ROUTE_NAME', 'ARRIVAL_ICAO_CITY'];
        fieldsToPreserve.forEach(id => {
            const element = document.getElementById(id);
            if (element && element.value) {
                formFields[id] = element.value;
            }
        });
    }

    // Restore form fields if they get cleared
    function restoreFormFields() {
        if (isRestoring) return;
        isRestoring = true;
        try {
            Object.keys(formFields).forEach(id => {
                const element = document.getElementById(id);
                if (element && !element.value && formFields[id]) {
                    element.value = formFields[id];
                }
            });
        } finally {
            isRestoring = false;
        }
    }

    // Check fields periodically and after tab changes
    setInterval(restoreFormFields, 1000);
    document.querySelectorAll('.tablinks').forEach(tab => {
        tab.addEventListener('click', () => setTimeout(restoreFormFields, 100));
    });

    function checkMetarAge() {
      /* Check datetime of METAR data and update UI colors.
       *
       * This function checks the datetime of displayed METAR data and updates the UI to indicate staleness.
       * If METAR data is older than 15 minutes:
       * - Sets elements' background to light red
       * Used to visually alert user that METAR data should be refreshed.
       */
        function updateColors(prefix) {
            const dateField = document.getElementById(`datetime-metar-taf-${prefix}`);
            const button = document.getElementById(`metar-taf-embed-${prefix}`);
            if (!dateField?.value) return;

            // Parse the date parts
            const [datePart, timePart] = dateField.value.split(' ');
            const [day, month, year] = datePart.split('-');
            const [hours, minutes] = timePart.split(':');

            // Create date objects with the same timezone
            const metarTime = new Date();
            metarTime.setFullYear(parseInt(year), parseInt(month) - 1, parseInt(day));
            metarTime.setHours(parseInt(hours), parseInt(minutes), 0, 0);

            const now = new Date();
            const diff = now - metarTime;
            const isOld = diff > 15 * 60 * 1000; // 15 minutes in milliseconds

            dateField.style.backgroundColor = isOld ? '#ffebee' : '';
            button.style.backgroundColor = isOld ? '#ffebee' : '';
        }

        updateColors('departure');
        updateColors('arrival');
    }

    // Initial check and start interval
    checkMetarAge();
    setInterval(checkMetarAge, 60000); // Check every minute

    function createMetarWidget(containerId, icao, name, uniqueSuffix) {
      console.log(`üõ´ Creating METAR widget for ${icao}`);
      if (icao === 'unknown') {
          window.alert("Please fill in ICAO field first before loading METAR data");
          return;
      }

      // Clear previous widget (if any)
        const container = document.getElementById(containerId);
        container.innerHTML = '';

        // Create unique ID for this widget instance
        const widgetId = `metartaf-${uniqueSuffix}`;


        // Create <a> element
        const link = document.createElement('a');
        link.href = `https://metar-taf.com/metar/${icao}`;
        link.id = widgetId;
        link.textContent = `METAR ${name}`;
        link.style = "font-size:16px; font-weight:500; color:#000; width:310px; height:435px; display:block";

        // Append link to container
        container.appendChild(link);

        // Create <script> element
        const script = document.createElement('script');
        script.async = true;
        script.defer = true;
        script.crossOrigin = "anonymous";
        script.src = `https://metar-taf.com/embed-js/${icao}?u=39426&qnh=hPa&rh=dp&target=${uniqueSuffix}`;

        // Append script to container
        container.appendChild(script);
    }

    // Event listener for button
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('metar-taf-embed-departure')?.addEventListener('click', () => {
        const name = document.getElementById('DEPARTURE_NAME').value || 'Unknown Airport';
        const icao = document.getElementById('DEPARTURE_ICAO').value.toUpperCase() || 'unknown';
        // Update datetime field with current time
        const now = new Date();
        const dateStr = String(now.getDate()).padStart(2, '0') + '-' +
                        String(now.getMonth() + 1).padStart(2, '0') + '-' +
                        now.getFullYear() + ' ' +
                        String(now.getHours()).padStart(2, '0') + ':' +
                        String(now.getMinutes()).padStart(2, '0');
        // Reset colors
        const button = document.getElementById('metar-taf-embed-departure');
        const dateField = document.getElementById('datetime-metar-taf-departure');
        button.style.backgroundColor = '';
        dateField.style.backgroundColor = '';
        dateField.value = dateStr;
        // Create the widget
        createMetarWidget('departureWidgetContainer', icao, name, 'DEPARTURE');
        });

        document.getElementById('metar-taf-embed-arrival')?.addEventListener('click', () => {
        const name = document.getElementById('ARRIVAL_NAME').value || 'Unknown Airport';
        const icao = document.getElementById('ARRIVAL_ICAO').value.toUpperCase() || 'unknown';
        // Update datetime field with current time
        const now = new Date();
        const dateStr = String(now.getDate()).padStart(2, '0') + '-' +
                        String(now.getMonth() + 1).padStart(2, '0') + '-' +
                        now.getFullYear() + ' ' +
                        String(now.getHours()).padStart(2, '0') + ':' +
                        String(now.getMinutes()).padStart(2, '0');
        // Reset colors
        const button = document.getElementById('metar-taf-embed-arrival');
        const dateField = document.getElementById('datetime-metar-taf-arrival');
        button.style.backgroundColor = '';
        dateField.style.backgroundColor = '';
        dateField.value = dateStr;
        // Create the widget
        createMetarWidget('arrivalWidgetContainer', icao, name, 'ARRIVAL');
      });
    });

    </script>

<script>
    // Populate dropdowns and setup event listeners on page load
    window.addEventListener('DOMContentLoaded', () => {
    // Populate dropdowns
    // populateDropdown('DEPARTURE_COUNTRY_DEFAULT', COUNTRIES_DATA);
    // populateDropdown('ARRIVAL_COUNTRY_DEFAULT', COUNTRIES_DATA);

    console.log('Settings initialized');

    // Update settings when changed
    document.getElementById('user_usage_type').addEventListener('change', (e) => {
        if (window.settings) {
            window.settings.user_usage_type = e.target.value;
            console.log('Updated output type:', window.settings.user_usage_type);
            window.settings.fontsizes = window.set_fontsizes({
                user_usage_type: window.settings.user_usage_type,
                user_select_cols: window.settings.user_select_cols
            });
        }
    });

    document.getElementById('user_select_cols').addEventListener('change', (e) => {
        if (window.settings) {
            window.settings.user_select_cols = e.target.value;
            console.log('Updated nr. columns:', window.settings.user_select_cols);
            window.settings.fontsizes = window.set_fontsizes({
                user_usage_type: window.settings.user_usage_type,
                user_select_cols: window.settings.user_select_cols
            });
        }
    });

    // document.getElementById('DEPARTURE_COUNTRY_DEFAULT').addEventListener('change', (e) => {
    //     if (window.settings) {
    //         window.settings.DEPARTURE_COUNTRY = e.target.value;
    //         console.log('Updated DEPARTURE_COUNTRY:', e.target.value);
    //     }
    // });

    // document.getElementById('ARRIVAL_COUNTRY_DEFAULT').addEventListener('change', (e) => {
    //     if (window.settings) {
    //         window.settings.ARRIVAL_COUNTRY = e.target.value;
    //         console.log('Updated ARRIVAL_COUNTRY:', e.target.value);
    //     }
    // });

    // document.getElementById('MAX_HEADWIND_LIMIT').addEventListener('change', (e) => {
    //     if (window.settings) {
    //         window.settings.MAX_HEADWIND_LIMIT = e.target.value;
    //         console.log('Updated MAX_HEADWIND_LIMIT:', e.target.value);
    //     }
    // });

    // document.getElementById('MAX_CROSSWIND_LIMIT').addEventListener('change', (e) => {
    //     if (window.settings) {
    //         window.settings.MAX_CROSSWIND_LIMIT = e.target.value;
    //         console.log('Updated MAX_CROSSWIND_LIMIT:', e.target.value);
    //     }
    // });
});

</script>


<!-- Javascript functionality -->
<script>
  // List of images to cache
  const IMAGES_TO_CACHE = {
    skywalk_logo: "https://erdogant.github.io/datasets/skywalk/figs/Slide2.PNG",
    coffee_image: "https://erdogant.github.io/datasets/skywalk/figs/buy_me_a_coffee.png"
  };
  // Default ICAO image URL (not cached with others since it's used differently)
  const DEFAULT_ICAO_IMAGE = "https://erdogant.github.io/datasets/skywalk/figs/oskar-kadaksoo-f_rLDn5m2XQ-unsplash.jpg";
  window.DEFAULT_ICAO_IMAGE = DEFAULT_ICAO_IMAGE

  const CACHE_NAME = "skywalk-cache-v1";

  // Function to cache and set image source
  async function cacheAndSetImage(url, imgElementId) {
    const cache = await caches.open(CACHE_NAME);

    // Try loading from cache
    let response = await cache.match(url);
    if (!response) {
      console.log(`Image not cached yet. Downloading: ${url}`);
      response = await fetch(url);
      await cache.put(url, response.clone());
    } else {
      console.log(`Loaded from cache: ${url}`);
    }

    const blob = await response.blob();
    const objectURL = URL.createObjectURL(blob);
    const imgElement = document.getElementById(imgElementId);
    if (imgElement) {
      imgElement.src = objectURL;
    } else {
      console.warn(`Image element not found: ${imgElementId}`);
    }
  }

  // Initialize caching on page load
  document.addEventListener("DOMContentLoaded", () => {
    for (const [elementId, url] of Object.entries(IMAGES_TO_CACHE)) {
      cacheAndSetImage(url, elementId);
    }

    // Load default departure image on page load
    cacheAndSetImage(DEFAULT_ICAO_IMAGE, 'DEPARTURE_image_cache');
    cacheAndSetImage(DEFAULT_ICAO_IMAGE, 'ARRIVAL_image_cache');
  });
</script>

<!-- PyScript configuration -->
<py-config>
  packages = ["pandas", "numpy", "jinja2"]
</py-config>

<!-- PyScript for flightplan functionality -->
  <script type="py">
    # Standard library imports
    import json
    import os
    import sys
    import re
    import pathlib
    import tempfile
    import base64
    from datetime import datetime
    from io import BytesIO
    from urllib.parse import urlparse
    import urllib.parse
    import webbrowser

    # Third party imports
    import pandas as pd
    import zipfile
    import ast
    import asyncio
    from jinja2 import Environment, DictLoader

    # JavaScript/browser imports
    import js
    from js import Blob, URL, window
    from pyodide.http import pyfetch
    from pyodide.ffi import create_proxy

    import logging
    logger = logging.getLogger('SKYWALK')

    async def load_cached_zip(cache_key, url=None):
        """Load data from cache or download and cache it
        Args:
            cache_key: Key to use for caching
            url: URL to fetch data from if not in cache
        Returns:
            bytes: The loaded data
        """
        if is_cached(cache_key):
            print(f"üì¶ Using cached data for: {cache_key}")
            cached_data = load_from_cache(cache_key)
            return cached_data

        if url:
            print(f"‚¨áÔ∏è Downloading from: {url}")
            data = await fetch_zip(url)
            if data:
                save_to_cache(cache_key, data, encode_base64=True)
                return data
        return None


    def get_default_settings():
        """Get default settings"""
        data = {
            'DEPARTURE_COUNTRY': '',
            'DEPARTURE_ICAO': '',
            'DEPARTURE_ICAO_CITY': '',
            'ARRIVAL_COUNTRY': '',
            'ARRIVAL_ICAO': '',
            'ARRIVAL_ICAO_CITY': '',
            'MAX_HEADWIND_LIMIT': 25,
            'MAX_CROSSWIND_LIMIT': 15,
            'user_usage_type': 'print',
            'user_select_cols': '2',
            'fontsizes': set_fontsizes(type('Params', (), {'user_usage_type': 'view', 'user_select_cols': '1'})),

            'METAR_stations': r'https://erdogant.github.io/datasets/skywalk/nsd_cccc.zip',

            'link_coffee': "https://www.buymeacoffee.com/erdogant",
            'link_skywalk': 'http://erdogant.github.io/skywalk-docs/',

            'FIG_DIR': r'https://erdogant.github.io/datasets/skywalk/figs/',
            'logo_coffee': r'https://erdogant.github.io/datasets/skywalk/figs/buy_me_a_coffee.png',
            'logo_skywalk': r'https://erdogant.github.io/datasets/skywalk/figs/Slide3.PNG',

            'img_default_icao': r'https://erdogant.github.io/datasets/skywalk/figs/oskar-kadaksoo-f_rLDn5m2XQ-unsplash.jpg',
            'img_default_wind_envelope': r'https://erdogant.github.io/datasets/skywalk/figs/windsock_mark-konig-OsYYPaPgIjw-unsplash.jpg',
            'url_default_wind_envelope': 'https://erdogant.github.io/skywalk-docs/pages/html/Departure_Arrival.html#cloud-plot',
            'img_default_cloud_plot': r'https://erdogant.github.io/datasets/skywalk/figs/dylan-mcleod-vY7GkgvTj-k-unsplash.jpg',
            'url_default_cloud_plot': 'https://erdogant.github.io/skywalk-docs/pages/html/Departure_Arrival.html#cloud-plot',

            'key_aerodromes': "GpZzcnXiLleytOr5Y7WC@",
            'url_aerodromes': 'https://erdogant.github.io/datasets/skywalk/aerodromes/',
            'url_aerodromes_images': 'https://erdogant.github.io/datasets/skywalk/aerodromes_images/',

            'html_templates': 'https://erdogant.github.io/datasets/skywalk/html_templates/',
        }
        return data

    def get_default_data():
        """Get default flightplan data structure - copied from utils_skywalk.py"""
        data = {
            # General/Flightplan
            'FLIGHTPLAN': '',           # Name of the flightplan
            'DATETIME': datetime.now().strftime('%d-%m-%Y %H:%M'),
            'CALLSIGN': '',             # Aircraft callsign
            'CALLSIGN_SHORT': '',       # Short callsign (auto-generated)
            'AIRCRAFT_TYPE': '',        # Aircraft type/model
            'FLIGHT_RULES': 'VFR',      # VFR/IFR
            'POB': '',                  # Persons on board

            # Departure
            'DEPARTURE_ICAO': '',               # ICAO code
            'DEPARTURE_ICAO_CITY': '',          # ICAO code with City
            'DEPARTURE_NAME': '',               # Aerodrome name
            'DEPARTURE_POSITION': '',           # Position at apron
            'DEPARTURE_RUNWAY': '',             # The user selected Runway
            'DEPARTURE_ELEVATION': '',          # The Runway ELEVATION
            'DEPARTURE_RUNWAYS': '',            # All available Runways
            'DEPARTURE_ROUTE_NAME': '',         # Departure route name
            'DEPARTURE_ROUTE_ALTITUDE': '',     # Departure route altitude
            'DEPARTURE_CIRCUIT_ALTITUDE': '',   # Departure circuit altitude
            'DEPARTURE_CTR': False,             # CTR checkbox state
            'DEPARTURE_COUNTRY': '',            # Country selection
            'DEPARTURE_IMAGE': None,            # Image of the departure
            'DEPARTURE_URL_WEBSITE': None,      # Website of the Aerodrome
            'DEPARTURE_URL_WIKIPEDIA': None,    # Website of the Aerodrome
            'DEPARTURE_LATLON': [None, None],   # Latlon
            'DEPARTURE_METAR_ICAO': '',         # METAR
            'DEPARTURE_METAR': {},              # METAR
            'DEPARTURE_WIND_ENVELOPE': {},      # WIND ENVELOPE
            'DEPARTURE_CLOUD': [],              # CLOUD DATA
            'DEPARTURE_TIMEZONE': '',           # Timezone

            # Departure ATC
            'DEPARTURE_ATC_TOWER': '',            # Tower/Radio frequency
            'DEPARTURE_ATC_ATIS_FREQ': '',        # ATIS frequency
            'DEPARTURE_ATC_GROUND': '',           # Delivery/Ground frequency
            'DEPARTURE_ATC_APPROACH': '',         # Approach
            'DEPARTURE_ATC_TELEPHONE': '',        # Telephone Tower

            # Arrival
            'ARRIVAL_ICAO': '',                   # ICAO code
            'ARRIVAL_ICAO_CITY': '',              # ICAO code with City
            'ARRIVAL_NAME': '',                   # Aerodrome name
            'ARRIVAL_POSITION': '',               # Position at apron
            'ARRIVAL_RUNWAY': '',                 # The user selected Runway
            'ARRIVAL_ELEVATION': '',              # The Runway ELEVATION
            'ARRIVAL_RUNWAYS': '',                # All available Runways
            'ARRIVAL_ROUTE_NAME': '',             # Arrival route name
            'ARRIVAL_ROUTE_ALTITUDE': '',         # Arrival route altitude
            'ARRIVAL_CIRCUIT_ALTITUDE': '',       # Arrival circuit altitude
            'ARRIVAL_CTR': False,                 # CTR checkbox state
            'ARRIVAL_COUNTRY': '',                # Country selection
            'ARRIVAL_IMAGE': None,                # Image of the departure
            'ARRIVAL_URL_WEBSITE': None,          # Website of the Aerodrome
            'ARRIVAL_URL_WIKIPEDIA': None,        # Website of the Aerodrome
            'ARRIVAL_LATLON': [None, None],       # Latlon
            'ARRIVAL_METAR_ICAO': '',             # METAR
            'ARRIVAL_METAR': {},                  # METAR
            'ARRIVAL_WIND_ENVELOPE': {},          # WIND ENVELOPE
            'ARRIVAL_CLOUD': [],                  # CLOUD DATA
            'ARRIVAL_TIMEZONE': '',               # Timezone

            # Arrival ATC
            'ARRIVAL_ATC_TOWER': '',        # Tower/Radio frequency
            'ARRIVAL_ATC_ATIS_FREQ': '',    # ATIS frequency
            'ARRIVAL_ATC_GROUND': '',       # Delivery/Ground frequency
            'ARRIVAL_ATC_APPROACH': '',     # Approach
            'ARRIVAL_ATC_TELEPHONE': '',    # Telephone Tower

            # Enroute
            'FIC_NAME': '',             # FIC name
            'FIC_FREQUENCY': '',        # FIC frequency
            'OVERHEAD': '',             # Overhead point
            'SQUAWK': '',               # Squawk code

            # Enroute (second FIC/overhead/squawk)
            'FIC_NAME2': '',            # Second FIC name
            'FIC_FREQUENCY2': '',       # Second FIC frequency
            'OVERHEAD2': '',            # Second overhead point
            'SQUAWK2': '',             # Second squawk code

            # NOTAM data
            'NOTAM': {'data': {}},      # NOTAM data
        }
        return data

    # Cache Helpers
    def clear_cache():
        """Clear all cached data from localStorage"""
        try:
            # Clears everything stored in localStorage
            js.localStorage.clear()

            # If you also use sessionStorage:
            js.sessionStorage.clear()
            print("üßπ Cache cleared successfully")
            return True
        except Exception as e:
            print(f"‚ùå Error clearing cache: {e}")
            return False

    def is_cached(cache_key):
        try:
            cached = js.localStorage.getItem(f"skywalk_{cache_key}")
            # Check if value exists and is truthy (not null/undefined)
            return bool(cached)
        except:
            return False

    def save_to_cache(cache_key, data, encode_base64=False):
        """Save data to localStorage with optional base64 encoding"""
        try:
            if encode_base64:
                data = base64.b64encode(data).decode('utf-8')
            js.localStorage.setItem(f"skywalk_{cache_key}", data)
            print(f"üíæ Cached {cache_key}: {len(data)} bytes")
            return True
        except Exception as e:
            print(f"‚ùå Error saving to cache: {e}")
            return False


    def load_from_cache(cache_key):
        try:
            cached_data = js.localStorage.getItem(f"skywalk_{cache_key}")
            if cached_data:
                # Decode base64 string to bytes
                data = base64.b64decode(cached_data)
                print(f"üì¶ Loaded {len(data)} bytes from cache")
                return data
            print("‚ö†Ô∏è Cache returned null, downloading...")
            return None
        except Exception as e:
            print(f"‚ö†Ô∏è Error decoding cached data: {e}")
            return None

    # Fetch ZIP from remote and save to cache
    async def fetch_zip(url):
        filepath = urlparse(url).path
        zipname = os.path.splitext(os.path.basename(filepath))[0]
        print(f"üì• Fetching: {url}")
        print(f"üì• Fetching: {zipname}")

        response = await pyfetch(url)
        if response.ok:
            # Get bytes directly as Python bytes object
            zip_bytes = await response.bytes()
            save_to_cache(zipname, zip_bytes, encode_base64=True)
            return zip_bytes
        else:
            print(f"‚ùå Failed to download {url} - Status: {response.status}")
            js.document.getElementById('loading-spinner').style.display = 'none'
            return None

    # Extract CSV inside the ZIP
    def extract_csv_from_zip(zip_bytes, password=None):
        try:
            print(f"üîì Extracting ZIP file ({len(zip_bytes)} bytes)...")
            with zipfile.ZipFile(BytesIO(zip_bytes)) as z:
                files = z.namelist()
                print(f"üìÇ Files in ZIP: {files}")
                name = files[0]  # First file in ZIP
                print(f"üìÑ Reading: {name}")
                if password is None:
                    with z.open(name) as f:
                        df = pd.read_csv(f, sep=';')
                else:
                    with z.open(name, pwd=password.encode()) as f:
                        df = pd.read_csv(f, sep=';')
                print(f"‚úÖ CSV parsed: {len(df)} rows, {len(df.columns)} columns")
            return df
        except zipfile.BadZipFile as e:
            print(f"‚ùå BadZipFile error: {e}")
            print(f"First 100 bytes: {zip_bytes[:100]}")
            raise
        except Exception as e:
            print(f"‚ùå Error extracting CSV: {type(e).__name__}: {e}")
            js.document.getElementById('loading-spinner').style.display = 'none'
            raise

    # Main loader: called from JS
    async def import_aerodrome_selected(fname, country):
        print(f"üåç Loading {fname} aerodrome data for: {country}")
        zip_bytes = None

        url = js.window.settings['url_aerodromes'] + country + ".zip"
        zip_bytes = await load_cached_zip(f"aerodrome_{country}", url)

        if zip_bytes:
            PASSWORD = js.window.settings['key_aerodromes']
            df = extract_csv_from_zip(zip_bytes, PASSWORD)
            js.console.log(f"‚úÖ Aerodromes loaded for {country}: {len(df)} rows.")
            print(f"‚úÖ Successfully loaded {len(df)} aerodromes for {country}")

            # For now, just show the first few entries
            # print(df.head().to_string())
            # print(f"Available columns: {df.columns.tolist()}")

            # Store data in global variable
            if fname == 'DEPARTURE':
                js.window.AERODROME_DEPARTURE_DATA = df.to_dict('records')
            else:
                js.window.AERODROME_ARRIVAL_DATA = df.to_dict('records')

            # Populate DEPARTURE_ICAO_CITY dropdown with aerodrome data
            if 'city_icao' in df.columns:
                icao_codes = df['city_icao'].dropna().unique().tolist()
                print(f"üìç Found {len(icao_codes)} unique ICAO cities")

                # Clear and populate the dropdown
                select = js.document.getElementById(f'{fname}_ICAO_CITY')
                if select:
                    # Clear existing options except the first placeholder
                    select.innerHTML = '<option value="">ICAO City</option>'

                    # Add each ICAO city as an option
                    for icao in sorted(icao_codes):
                        option = js.document.createElement('option')
                        option.value = icao
                        option.textContent = icao
                        select.appendChild(option)

                    print(f"‚úÖ Populated {fname}_ICAO_CITY dropdown with {len(icao_codes)} cities")
                else:
                    print(f"‚ö†Ô∏è {fname}_ICAO_CITY dropdown not found")
            else:
                print(f"‚ö†Ô∏è '{fname}_city_icao' column not found in dataframe")
                print(f"Available columns: {df.columns.tolist()}")
        else:
            print("‚ö†Ô∏è No data available")

        # Hide loading spinner when done
        js.document.getElementById('loading-spinner').style.display = 'none'


    async def populate_aerodrome_fields_from_icao(fname, city_icao):
        """Populate departure/arrival fields when ICAO city is selected."""
        print(f"üîç Searching for data: {city_icao}")

        # Get the stored dataframe
        if not hasattr(js.window, f'AERODROME_{fname}_DATA'):
            print(f"‚ö†Ô∏è No aerodrome data available:'AERODROME_{fname}_DATA'")
            return

        # Get data
        if fname == 'DEPARTURE':
            df = js.window.AERODROME_DEPARTURE_DATA
        elif fname == 'ARRIVAL':
            df = js.window.AERODROME_ARRIVAL_DATA

        # Get data for specific ICAO
        row_dict = get_icao_data(df, city_icao)

        if not row_dict:
            print(f"‚ö†Ô∏è No data found for {city_icao}")
            return

        # Get runway data
        rwy_ids, rwy_list = retrieve_runways(row_dict)

        # Store data
        CTR_BOOL = row_dict['AERODROME_CTR']
        FREQ_TOWER_RADIO = row_dict['freqs.TOWER'] if CTR_BOOL else row_dict['freqs.RADIO']
        js.window.flight_plan_data[f"{fname}_ICAO"] = row_dict['icao']
        js.window.flight_plan_data[f"{fname}_ICAO_CITY"] = city_icao
        js.window.flight_plan_data[f"{fname}_RUNWAYS"] = rwy_ids
        js.window.flight_plan_data[f"{fname}_RUNWAY"] = normalize_freq(rwy_ids)
        js.window.flight_plan_data[f"{fname}_NAME"] = row_dict['name']
        js.window.flight_plan_data[f"{fname}_ELEVATION"] = str(row_dict['elevation_aerodrome'])
        js.window.flight_plan_data[f"{fname}_CTR"] = 'CTR' if CTR_BOOL else ''
        js.window.flight_plan_data[f"{fname}_COUNTRY"] = row_dict['country']
        js.window.flight_plan_data[f"{fname}_IMAGE"] = row_dict.get('url.wikipedia.aerodrome.image', None)
        js.window.flight_plan_data[f"{fname}_URL_WEBSITE"] = row_dict.get('url.website', '')
        js.window.flight_plan_data[f"{fname}_URL_WIKIPEDIA"] = row_dict.get('url.wikipedia', '')
        js.window.flight_plan_data[f"{fname}_LATLON"] = [row_dict.get('lat', None), row_dict.get('lon', None)]
        js.window.flight_plan_data[f"{fname}_TIMEZONE"] = row_dict.get('tz', None)

        if fname == 'DEPARTURE':
            # Handle FREQ_TOWER_RADIO
            js.window.flight_plan_data["DEPARTURE_ATC_TOWER"] = normalize_freq(FREQ_TOWER_RADIO)

            # MAPPING OF THE FREQUENCIES
            field_mapping = {
              f"{fname}_ATC_ATIS_FREQ": 'freqs.ATIS',
              f"{fname}_ATC_GROUND": 'freqs.DELIVERY/GROUND',
              f"{fname}_ATC_APPROACH": 'freqs.APPROACH',
              f"{fname}_ATC_TELEPHONE": 'freqs.TELEPHONE',
              'FIC_NAME': 'freqs.FIC_NAME',
              'FIC_FREQUENCY': 'freqs.FIC_FREQUENCY',
              'FIC_NAME2': 'freqs.FIC_NAME_2',
              'FIC_FREQUENCY2': 'freqs.FIC_FREQUENCY_2',
            }

            # FILL THE FREQUENCIES
            for key, colname in field_mapping.items():
              freq_raw = row_dict[colname]
              freq_clean = normalize_freq(freq_raw)
              js.window.flight_plan_data[key] = freq_clean
              print(f"  {key}: {js.window.flight_plan_data[key]}")

        # Update all GUI fields from flight_plan_data
        update_aerodrome_gui_fields('DEPARTURE')
        update_aerodrome_gui_fields('ARRIVAL')

        # Update departure image
        await update_aerodrome_image('DEPARTURE')
        await update_aerodrome_image('ARRIVAL')

    def normalize_freq(value):
        # Convert to string and strip brackets/quotes
        freq_str = str(value).strip().strip('[]').replace("'", "").replace('"', '')
        # Split, clean, and filter empty items
        parts = [f.strip() for f in freq_str.split(',') if f.strip()]
        # Return
        return ', '.join(parts)

    def create_callsign_short(CALLSIGN):
        # Create short callsign automatically
        CALLSIGN_SHORT = ''
        if CALLSIGN is not None and CALLSIGN != '':
            CALLSIGN_SHORT = CALLSIGN[0] + CALLSIGN[-2:]
        return CALLSIGN_SHORT

    def TEXT_INFORMATION_RECEIVED():
        """Return text confirming information received"""
        return '<br><br>INFORMATION <strong class="pilot_text"> [ .   .   .   .   .   . ]</strong> RECEIVED,'

    async def clear_general_fields():
        """Clear all GENERAL GUI fields and flight_plan_data"""
        print("üßπ Clearing all GENERAL fields...")

        # List of all departure fields to clear
        field_ids = [
          'FLIGHTPLAN',
          'DATETIME',
          'CALLSIGN',
          'AIRCRAFT_TYPE',
          'FLIGHT_RULES_spinner',
          'POB',
        ]

        # Clear GUI fields
        for field_id in field_ids:
            element = js.document.getElementById(field_id)
            if element:
                if field_id == 'FLIGHT_RULES_spinner':
                    element.value = 'VFR'
                else:
                    element.value = ''

        # Clear flight_plan_data for departure fields
        keys = [
            'FLIGHTPLAN', 'DATETIME', 'CALLSIGN', 'CALLSIGN_SHORT',
            'AIRCRAFT_TYPE', 'FLIGHT_RULES', 'POB',
        ]

        for key in keys:
            if key == 'FLIGHT_RULES':
                js.window.flight_plan_data[key] = 'VFR'
            else:
                js.window.flight_plan_data[key] = ''


    def update_aerodrome_gui_fields(fname):
        """Update all DEPARTURE/ARRIVAL GUI fields from js.window.flight_plan_data"""
        print("üîÑ Updating DEPARTURE/ARRIVAL GUI fields...")

        # List of field IDs to update
        field_ids = [
            f'{fname}_COUNTRY',
            f'{fname}_ICAO_CITY',
            f'{fname}_COUNTRY',
            f'{fname}_NAME',
            f'{fname}_ICAO',
            f'{fname}_POSITION',
            f'{fname}_RUNWAY',
            f'{fname}_ELEVATION',
            f'{fname}_ROUTE_NAME',
            f'{fname}_ROUTE_ALTITUDE',
            f'{fname}_CIRCUIT_ALTITUDE',
            f'{fname}_ATC_TOWER',
            f'{fname}_ATC_APPROACH',
            f'{fname}_ATC_ATIS_FREQ',
            f'{fname}_ATC_GROUND',
            f'{fname}_ATC_TELEPHONE',
        ]

        # Only update these fields based on DEPARTURE
        if fname == 'DEPARTURE':
            field_ids = field_ids + [
                'FIC_NAME',
                'FIC_FREQUENCY',
                'SQUAWK',
                'OVERHEAD',
                'FIC_NAME2',
                'FIC_FREQUENCY2',
                'SQUAWK2',
                'OVERHEAD2',
            ]

        updated_count = 0
        for field_id in field_ids:
            # Get the value from flight_plan_data
            value = js.window.flight_plan_data.get(field_id)

            # Get the HTML element
            element = js.document.getElementById(field_id)

            if element:
                # Convert value to string and handle special cases
                if value is not None and value != '' and str(value) != 'nan' and str(value) != 'None':
                    # Handle boolean for CTR
                    if field_id == f'{fname}_CTR':
                        if value or str(value).lower() == 'true':
                            element.value = 'CTR'
                        else:
                            element.value = ''
                    else:
                        element.value = str(value)

                    updated_count += 1
                    print(f"  ‚úì Updated {field_id}: {element.value}")
                else:
                    # Clear the field if no value
                    element.value = ''
            else:
                print(f"  ‚ö†Ô∏è Element not found: {field_id}")

        print(f"‚úÖ Updated {updated_count} GUI fields")

    async def clear_enroute_fields():
        """Clear all ENROUTE GUI fields and flight_plan_data"""
        print("üßπ Clearing all ENROUTE fields...")

        field_ids = [
            'FIC_NAME',
            'FIC_FREQUENCY',
            'FIC_NAME2',
            'FIC_FREQUENCY2'
            'SQUAWK',
            'OVERHEAD',
            'SQUAWK2',
            'OVERHEAD2',
        ]

        # Clear GUI fields
        for field_id in field_ids:
            element = js.document.getElementById(field_id)
            if element:
                element.value = ''

        # Clear flight_plan_data for enroute fields
        enroute_keys = [
            'FIC_NAME', 'FIC_FREQUENCY', 'FIC_NAME2', 'FIC_FREQUENCY2',
            'OVERHEAD', 'OVERHEAD2', 'SQUAWK', 'SQUAWK2',
        ]

        for key in enroute_keys:
            js.window.flight_plan_data[key] = ''


    async def clear_aerodrome_fields(fname):
        """Clear all GENERAL GUI fields and flight_plan_data"""
        print(f"üßπ Clearing all {fname} fields...")

        # List of all departure/arrival fields to clear
        field_ids = [
            f'{fname}_COUNTRY',
            f'{fname}_ICAO_CITY',
            f'{fname}_CTR',
            f'{fname}_NAME',
            f'{fname}_ICAO',
            f'{fname}_POSITION',
            f'{fname}_RUNWAY',
            f'{fname}_ELEVATION',
            f'{fname}_ROUTE_NAME',
            f'{fname}_ROUTE_ALTITUDE',
            f'{fname}_CIRCUIT_ALTITUDE',
            f'{fname}_ATC_TOWER',
            f'{fname}_ATC_APPROACH',
            f'{fname}_ATC_ATIS_FREQ',
            f'{fname}_ATC_GROUND',
            f'{fname}_ATC_TELEPHONE',
        ]

        # Clear GUI fields
        for field_id in field_ids:
            element = js.document.getElementById(field_id)
            if element:
                element.value = ''

        # Clear flight_plan_data for departure fields
        departure_keys = [
            f'{fname}_COUNTRY', f'{fname}_ICAO_CITY',
            f'{fname}_ICAO', f'{fname}_ICAO_CITY', f'{fname}_NAME',
            f'{fname}_POSITION', f'{fname}_RUNWAY', f'{fname}_ELEVATION',
            f'{fname}_RUNWAYS', f'{fname}_ROUTE_NAME', f'{fname}_ROUTE_ALTITUDE',
            f'{fname}_CIRCUIT_ALTITUDE', f'{fname}_CTR', f'{fname}_IMAGE',
            f'{fname}_URL_WEBSITE', f'{fname}_URL_WIKIPEDIA', f'{fname}_LATLON',
            f'{fname}_METAR_ICAO', f'{fname}_METAR', f'{fname}_WIND_ENVELOPE',
            f'{fname}_CLOUD', f'{fname}_TIMEZONE', f'{fname}_ATC_TOWER',
            f'{fname}_ATC_ATIS_FREQ', f'{fname}_ATC_GROUND', f'{fname}_ATC_APPROACH',
            f'{fname}_ATC_TELEPHONE',
        ]

        for key in departure_keys:
            if key == f'{fname}_CTR':
                js.window.flight_plan_data[key] = False
            elif key == f'{fname}_LATLON':
                js.window.flight_plan_data[key] = [None, None]
            elif key in [f'{fname}_METAR', f'{fname}_WIND_ENVELOPE']:
                js.window.flight_plan_data[key] = {}
            elif key in [f'{fname}_CLOUD', f'{fname}_RUNWAYS']:
                js.window.flight_plan_data[key] = []
            else:
                js.window.flight_plan_data[key] = ''

        # Reset to default image
        await clear_aerodrome_image(fname)


    async def update_aerodrome_image(fname):
        """Update image from DEPARTURE_IMAGE or ARRIVAL_IMAGE or use default"""
        print(f"üñºÔ∏è Updating {fname} image...")

        # Get the image URL from flight_plan_data
        image_url1 = os.path.join(js.window.settings['url_aerodromes_images'], js.window.flight_plan_data[f'{fname}_ICAO']) + '.png' if js.window.flight_plan_data[f'{fname}_ICAO'] != '' else None
        image_url2 = js.window.flight_plan_data.get(f'{fname}_IMAGE')
        image_url3 = js.DEFAULT_ICAO_IMAGE

        for image_url in [image_url1, image_url2, image_url3]:
            if await cache_and_display_image(image_url, f'{fname}_image_cache'):
                print(f"  üìã {fname}_IMAGE from flight_plan_data: {image_url}")
                break


    async def clear_aerodrome_image(fname):
        """Reset aerodrome image to default"""
        print("üîÑ Resetting to default image...")
        await cache_and_display_image(js.DEFAULT_ICAO_IMAGE, f'{fname}_image_cache')


    async def cache_and_display_image(url, img_element_id):
        """Cache and display an image using browser cache API"""
        # If the URL is invalid or missing, return without displaying an image
        if not url or str(url) == 'None' or str(url) == '' or str(url) == 'nan' or not str(url).startswith('http'):
            return False

        try:
            cache = await js.caches.open("skywalk-cache-v1")

            # Try loading from cache
            response = await cache.match(url)

            if not response:
                print(f"  üì• Image not cached, downloading: {url}")
                response = await js.fetch(url)
                if response.ok:
                    await cache.put(url, response.clone())
                else:
                    print(f"  ‚ùå Failed to fetch image: {response.status}")
                    return False
            else:
                print(f"  üì¶ Loaded from cache: {url}")

            # Convert response to blob and display
            blob = await response.blob()
            object_url = js.URL.createObjectURL(blob)
            js.document.getElementById(img_element_id).src = object_url
            print(f"  ‚úÖ Image displayed: {img_element_id}")
            return True

        except Exception as e:
            print(f"  ‚ùå Error caching/displaying image: {e}")
            raise
            return False


    def get_icao_data(df, city_icao, colname='city_icao'):
        """Load custom icao from disk and update"""
        row_dict = {}
        for df_row in df:
            if df_row.get('city_icao') == city_icao:
                row_dict = df_row
                break
        # Return
        return row_dict


    def retrieve_runways(row_dict):
        """Retrieve the runways from ICAO"""
        # row_dict = get_icao_data(df, city_icao)
        rwy_ids, rwy_list = [], []

        # Get all INFORMATION for the selected ICAO
        if row_dict:
            runways = row_dict.get("runways", [])
            if isinstance(runways, str): runways = ast.literal_eval(runways)
            rwy_ids = [r["id"] for r in runways if isinstance(r, dict) and "id" in r]
            rwy_list = options_runway_number(runways)

        # Return
        return rwy_ids, rwy_list


    def options_runway_number(data):
        """Retrieve all available runways based on aerodrome ICAO."""
        runways = []
        if data is not None:
            runways = [num for rwy in data for num in rwy.get("number", [])]
            runways = list(filter(lambda x: x != '', runways))

        # Return
        return runways


    async def clear_enroute_fields():
        """Clear all ENROUTE GUI fields and flight_plan_data"""
        print("üßπ Clearing all ENROUTE fields...")

        # Clear GUI fields
        js.document.getElementById('OVERHEAD').value = ''
        js.document.getElementById('OVERHEAD2').value = ''
        js.document.getElementById('SQUAWK').value = ''
        js.document.getElementById('SQUAWK2').value = ''
        js.document.getElementById('FIC_NAME').value = ''
        js.document.getElementById('FIC_NAME2').value = ''
        js.document.getElementById('FIC_FREQUENCY').value = ''
        js.document.getElementById('FIC_FREQUENCY2').value = ''

        # Clear flight_plan_data
        keys = ['OVERHEAD', 'OVERHEAD2', 'SQUAWK', 'SQUAWK2',
                'FIC_NAME', 'FIC_NAME2', 'FIC_FREQUENCY', 'FIC_FREQUENCY2']
        for key in keys:
            js.window.flight_plan_data[key] = ''

    async def create_new_flightplan():
        """Initialize new flightplan - returns current datetime for UI"""
        # Get current datetime for UI
        current_time = datetime.now().strftime("%d-%m-%Y %H:%M")
        print("New flightplan initialized - fields cleared")

        # Clear fields
        await clear_general_fields()
        await clear_aerodrome_fields('DEPARTURE')
        await clear_aerodrome_fields('ARRIVAL')
        await clear_enroute_fields()

        return current_time

    async def load_flightplan():
        """Load selected flightplan from localStorage"""
        plan_name = js.document.getElementById('plan_spinner').value

        if not plan_name or plan_name == "":
            print("‚ö†Ô∏è No flightplan selected")
            return

        print(f"üìÇ Loading flightplan: {plan_name}")

        # Load from localStorage
        storage_key = f"flightplan_{plan_name}"
        json_data = js.localStorage.getItem(storage_key)

        if not json_data:
            print(f"‚ö†Ô∏è Flightplan not found: {plan_name}")
            js.window.alert(f"‚ö†Ô∏è Flightplan '{plan_name}' not found")
            return

        # Parse JSON
        try:
            flight_plan_dict = json.loads(json_data)
            print(f"‚úÖ Loaded {len(flight_plan_dict)} fields")

            # Update js.window.flight_plan_data
            for key, value in flight_plan_dict.items():
                js.window.flight_plan_data[key] = value

            # Update General tab fields
            if flight_plan_dict.get('FLIGHTPLAN'):
                js.document.getElementById('FLIGHTPLAN').value = flight_plan_dict['FLIGHTPLAN']
            if flight_plan_dict.get('CALLSIGN'):
                js.document.getElementById('CALLSIGN').value = flight_plan_dict['CALLSIGN']
            if flight_plan_dict.get('AIRCRAFT_TYPE'):
                js.document.getElementById('AIRCRAFT_TYPE').value = flight_plan_dict['AIRCRAFT_TYPE']
            if flight_plan_dict.get('POB'):
                js.document.getElementById('POB').value = flight_plan_dict['POB']
            if flight_plan_dict.get('FLIGHT_RULES'):
                js.document.getElementById('FLIGHT_RULES_spinner').value = flight_plan_dict['FLIGHT_RULES']
            if flight_plan_dict.get('DATETIME'):
                js.document.getElementById('DATETIME').value = flight_plan_dict['DATETIME']

            # Update Departure tab fields - call the GUI update function
            update_aerodrome_gui_fields('DEPARTURE')
            update_aerodrome_gui_fields('ARRIVAL')
            # Update departure image
            await update_aerodrome_image('DEPARTURE')
            await update_aerodrome_image('ARRIVAL')

            print(f"‚úÖ Flightplan '{plan_name}' loaded successfully")

        except Exception as e:
            print(f"‚ùå Error loading flightplan: {e}")
            js.window.alert(f"‚ùå Error loading flightplan: {e}")

    async def delete_flightplan():
        """Delete selected flightplan from localStorage"""
        plan_name = js.document.getElementById('plan_spinner').value

        if not plan_name or plan_name == "":
            print("‚ö†Ô∏è No flightplan selected")
            return

        # Confirm deletion
        if not js.window.confirm(f"Are you sure you want to delete '{plan_name}'?"):
            print("‚ùå Deletion cancelled")
            return

        # Delete from localStorage
        storage_key = f"flightplan_{plan_name}"
        js.localStorage.removeItem(storage_key)
        print(f"‚úÖ Flightplan '{plan_name}' deleted")

        # Clear the dropdown selection
        js.document.getElementById('plan_spinner').value = ""

        # Update the flightplan list
        update_flightplan_list()

        """Create new flightplan with current timestamp"""
        # Create new flightplan
        await clear_general_fields()
        await clear_aerodrome_fields('DEPARTURE')
        await clear_aerodrome_fields('ARRIVAL')
        await clear_enroute_fields()

    def save_flightplan():
        """Save current flightplan data to localStorage"""

        # Read current values from input fields
        js.window.flight_plan_data["FLIGHTPLAN"] = js.document.getElementById('FLIGHTPLAN').value;
        js.window.flight_plan_data["POB"] = js.document.getElementById('POB').value;
        js.window.flight_plan_data["FLIGHT_RULES"] = js.document.getElementById('FLIGHT_RULES_spinner').value;
        js.window.flight_plan_data["DATETIME"] = js.document.getElementById('DATETIME').value;
        js.window.flight_plan_data["AIRCRAFT_TYPE"] = js.document.getElementById('AIRCRAFT_TYPE').value;
        js.window.flight_plan_data["CALLSIGN"] = js.document.getElementById('CALLSIGN').value;
        js.window.flight_plan_data["CALLSIGN_SHORT"] = js.window.create_callsign_short(js.document.getElementById('CALLSIGN').value);

        # Read Enroute tab fields
        js.window.flight_plan_data["FIC_NAME"] = js.document.getElementById('FIC_NAME').value;
        js.window.flight_plan_data["FIC_FREQUENCY"] = js.document.getElementById('FIC_FREQUENCY').value;
        js.window.flight_plan_data["OVERHEAD"] = js.document.getElementById('OVERHEAD').value;
        js.window.flight_plan_data["SQUAWK"] = js.document.getElementById('SQUAWK').value;
        js.window.flight_plan_data["FIC_NAME2"] = js.document.getElementById('FIC_NAME2').value;
        js.window.flight_plan_data["FIC_FREQUENCY2"] = js.document.getElementById('FIC_FREQUENCY2').value;
        js.window.flight_plan_data["OVERHEAD2"] = js.document.getElementById('OVERHEAD2').value;
        js.window.flight_plan_data["SQUAWK2"] = js.document.getElementById('SQUAWK2').value;

        # Get flightplan name
        flightplan_name = js.window.flight_plan_data.get("FLIGHTPLAN", "")

        if not flightplan_name or flightplan_name == "":
            print("‚ö†Ô∏è Flightplan not saved. Name is required")
            # js.window.alert("‚ö†Ô∏è Please enter a flightplan name before saving")
            return False

        # Print the saved variables array
        print("-------------SAVE FLIGHTPLAN DATA-------------")
        print(f"  Flightplan Name: {flightplan_name}")

        # Convert flight_plan_data to JSON string
        flight_plan_dict = {}
        keys = get_default_data()
        for key in keys:
            try:
                value = js.window.flight_plan_data.get(key)
                # Convert JavaScript objects to Python objects
                if hasattr(value, 'to_py'):
                    value = value.to_py()
                flight_plan_dict[key] = value
            except Exception as e:
                print(f"‚ö†Ô∏è Failed to save {key}: {e}")

        # Print saved data
        # for key, value in flight_plan_dict.items():
        #    if value != '' and value != None and value != {} and value != []:
        #        print(f"  {key}: '{value}'")

        # Convert to JSON string
        json_data = json.dumps(flight_plan_dict)

        # Save to localStorage with key "flightplan_[name]"
        storage_key = f"flightplan_{flightplan_name}"
        js.localStorage.setItem(storage_key, json_data)

        # Get localStorage info
        # print_local_storage()

        # Update the list of saved flightplans
        update_flightplan_list()

        print("---------------DATA SAVED-------------------")
        return True

    def print_local_storage():
        # Get localStorage info

        print(f"üíæ Saved to localStorage: {storage_key}")
        print(f"   Storage Type: Browser localStorage")
        print(f"   Storage Location: Browser's IndexedDB/localStorage database")
        print(f"   Key: {storage_key}")
        print(f"   Size: {len(json_data)} bytes")

        # Print browser-specific path hints
        print(f"   Browser localStorage is typically stored at:")
        if sys.platform == 'win32':
            print(f"   - Chrome: %LOCALAPPDATA%\\Google\\Chrome\\User Data\\Default\\Local Storage")
            print(f"   - Firefox: %APPDATA%\\Mozilla\\Firefox\\Profiles\\<profile>\\storage\\default")
            print(f"   - Edge: %LOCALAPPDATA%\\Microsoft\\Edge\\User Data\\Default\\Local Storage")
        elif sys.platform == 'darwin':
            print(f"   - Chrome: ~/Library/Application Support/Google/Chrome/Default/Local Storage")
            print(f"   - Firefox: ~/Library/Application Support/Firefox/Profiles/<profile>/storage/default")
            print(f"   - Safari: ~/Library/Safari/LocalStorage")
        else:
            print(f"   - Chrome: ~/.config/google-chrome/Default/Local Storage")
            print(f"   - Firefox: ~/.mozilla/firefox/<profile>/storage/default")

    def update_flightplan_list():
        """Update the flightplan dropdown with saved plans from localStorage"""
        print("üîÑ Updating flightplan list...")

        # Get all keys from localStorage
        storage_length = js.localStorage.length
        flightplan_names = []

        for i in range(storage_length):
            key = js.localStorage.key(i)
            if key and str(key).startswith('flightplan_'):
                # Extract flightplan name from key
                plan_name = str(key).replace('flightplan_', '')
                flightplan_names.append(plan_name)

        # Sort alphabetically
        flightplan_names.sort()

        # Update dropdown
        select = js.document.getElementById('plan_spinner')
        if select:
            # Clear existing options except the first placeholder
            select.innerHTML = '<option value="">Select flightplan</option>'

            # Add each flightplan as an option
            for plan_name in flightplan_names:
                option = js.document.createElement('option')
                option.value = plan_name
                option.textContent = plan_name
                select.appendChild(option)

            print(f"‚úÖ Found {len(flightplan_names)} saved flightplans")
        else:
            print("‚ö†Ô∏è Flightplan dropdown not found")

    async def create_summary_atc(reverse_path=False):
        """Create ATC summary (placeholder function)"""
        print("Creating ATC summary...")
        # Generate HTML content
        html_content = await generate_summary_html(reverse_path=reverse_path)
        # Open in browser
        # open_html(html_content, 'ATC_Summary_reverse' if reverse_path else 'ATC_Summary')
        open_html(html_content)

    async def create_departure_atc(reverse_path=False):
        """Create ATC Departure (placeholder function)"""
        print("Creating Departure summary...")
        # Generate HTML content
        html_content = await generate_departure_html(reverse_path=reverse_path)
        # Open in browser
        # open_html(html_content, 'ATC_Departure_reverse' if reverse_path else 'ATC_Departure')
        open_html(html_content)

    async def create_arrival_atc(reverse_path=False):
        """Create ATC Arrival (placeholder function)"""
        print("Creating Arrival summary...")
        # Generate HTML content
        html_content = await generate_arrival_html(reverse_path=reverse_path)
        # Open in browser
        # open_html(html_content, 'ATC_Arrival_reverse' if reverse_path else 'ATC_Arrival')
        open_html(html_content)

    async def create_enroute_atc(reverse_path=False):
        """Create ATC Enroute (placeholder function)"""
        print("Creating Enroute summary...")
        # Generate HTML content
        html_content = await generate_enroute_html(reverse_path=reverse_path)
        # Open in browser
        # open_html(html_content, 'ATC_Enroute_reverse' if reverse_path else 'ATC_Enroute')
        open_html(html_content)


    async def generate_summary_html(reverse_path=False):
        """Generate HTML content for summary screen similar to ATC_SUMMARY."""

        flight_data = js.window.flight_plan_data
        settings = js.window.settings

        try:
            # Set departure and arrival
            if reverse_path:
                DEPARTURE, ARRIVAL = 'ARRIVAL', 'DEPARTURE'
            else:
                DEPARTURE, ARRIVAL = 'DEPARTURE', 'ARRIVAL'

            # Prepare frequency and tower info
            ATC_FREQUENCIES = create_freq_list_combined([DEPARTURE, ARRIVAL])
            ATC_TOWER_FREQ_DEP, ATC_TOWER_NAME_DEP = get_ATC_TOWER(DEPARTURE)
            ATC_TOWER_FREQ_ARR, ATC_TOWER_NAME_ARR = get_ATC_TOWER(ARRIVAL)

            empty_field = '[ . . . . . . . . . ]'
            html_content = {
                'CALLSIGN': flight_data.get('CALLSIGN', '') or empty_field,
                'CALLSIGN_SHORT': flight_data.get('CALLSIGN_SHORT', '') or empty_field,
                'AIRCRAFT_TYPE': flight_data.get('AIRCRAFT_TYPE', '') or empty_field,
                'FLIGHT_RULES': flight_data.get('FLIGHT_RULES', '') or empty_field,
                'POB': flight_data.get('POB', '') or empty_field,

                'REQUEST_INFORMATION': '' if flight_data.get(f'{ARRIVAL}_CTR', False) else 'REQUEST AERODROME INFORMATION',
                'TEXT_INFORMATION_RECEIVED': TEXT_INFORMATION_RECEIVED() if flight_data.get(f'{ARRIVAL}_CTR', False) else '',
                'CTR_REGION_BOOL_DEPARTURE': 'true' if flight_data.get(f'{DEPARTURE}_CTR', False) else 'false',
                'CTR_REGION_BOOL_ARRIVAL': 'true' if flight_data.get(f'{ARRIVAL}_CTR', False) else 'false',

                'DEPARTURE_POSITION': flight_data.get(f'{DEPARTURE}_POSITION', '') or 'at the Apron',
                'DEPARTURE_RUNWAY': flight_data.get(f'{DEPARTURE}_RUNWAY', '') or empty_field,
                'DEPARTURE_NAME': flight_data.get(f'{DEPARTURE}_NAME', '') or empty_field,
                'DEPARTURE_ROUTE_NAME': flight_data.get(f'{DEPARTURE}_ROUTE_NAME', '') or empty_field,
                'DEPARTURE_ROUTE_ALTITUDE': flight_data.get(f'{DEPARTURE}_ROUTE_ALTITUDE', '') or empty_field,
                'DEPARTURE_ICAO': flight_data.get(f'{DEPARTURE}_ICAO', '') or empty_field,

                'FIC_NAME': flight_data.get('FIC_NAME', '') or empty_field,
                'FIC_FREQUENCY': flight_data.get('FIC_FREQUENCY', ''),
                'FIC_SQUAWK': flight_data.get('SQUAWK', ''),
                'OVERHEAD': flight_data.get('OVERHEAD', flight_data.get(f'{DEPARTURE}_ROUTE_NAME', '') or empty_field),
                'ATC_FREQUENCIES': ATC_FREQUENCIES,
                'ATC_ATIS_FREQ_DEP': flight_data.get(f'{DEPARTURE}_ATC_ATIS_FREQ', ''),
                'OVERHEAD2': flight_data.get('OVERHEAD2', ''),
                'FIC_SQUAWK2': flight_data.get('SQUAWK2', ''),

                'ATC_TOWER': ATC_TOWER_FREQ_DEP,
                'DELIVERY_OR_RADIO': ATC_TOWER_NAME_DEP if ATC_TOWER_NAME_DEP == 'RADIO' else 'DELIVERY',
                'ATC_GROUND': ATC_TOWER_FREQ_DEP if ATC_TOWER_NAME_DEP == 'RADIO' else flight_data.get(f'{DEPARTURE}_ATC_GROUND', ''),

                'ARRIVAL_ICAO': flight_data.get(f'{ARRIVAL}_ICAO', '') or empty_field,
                'ARRIVAL_ROUTE_ALTITUDE': flight_data.get(f'{ARRIVAL}_ROUTE_ALTITUDE', '') or empty_field,
                'ARRIVAL_NAME': flight_data.get(f'{ARRIVAL}_NAME', '') or empty_field,
                'ARRIVAL_ROUTE_NAME': flight_data.get(f'{ARRIVAL}_ROUTE_NAME', ''),
                'ATC_TOWER_ARR': ATC_TOWER_FREQ_ARR,
                'ATC_TOWER_NAME': ATC_TOWER_NAME_ARR,
                'ARRIVAL_RUNWAY': flight_data.get(f'{ARRIVAL}_RUNWAY', '') or empty_field,

                'GRID_COLUMNS': settings.get('user_select_cols', 1),
            }
            if reverse_path:
                html_content['FIC_NAME'] = flight_data.get('FIC_NAME2', '') or empty_field
                html_content['FIC_FREQUENCY'] = flight_data.get('FIC_FREQUENCY2', '')
                html_content['OVERHEAD'] = flight_data.get('OVERHEAD2', '')
                html_content['FIC_SQUAWK'] = flight_data.get('SQUAWK2', '')

            fontsizes = settings.get('fontsizes')

            css_content = {
                'FONT_SIZE_TOWER': fontsizes.get('TOWER'),
                'FONT_SIZE_PILOT': fontsizes.get('PILOT'),
                'FONT_SIZE_TITLE': fontsizes.get('TITLE'),
                'FONT_SIZE_SUBTITLE': fontsizes.get('TITLE') - 2,
                'BACKGROUND_COLOR_TITLE': '#6b21a8',
            }
            html_string = await personalize_content(html_content, 'ATC_summary_template.html.j2')
            css_string = await personalize_content(css_content, 'style_template.css.j2')

            html_with_css = f"""
            <style>
            {css_string}
            </style>
            {html_string}
            """
            return html_with_css
        except Exception as e:
            return f"<p>Error generating Summary HTML: {str(e)}</p>"


    async def generate_departure_html(reverse_path=False):
        """Generate HTML content for departure screen similar to ATC_DEPARTURE. """

        flight_data = js.window.flight_plan_data
        settings = js.window.settings

        try:
            # Set departure and arrival
            if reverse_path:
                DEPARTURE, ARRIVAL = 'ARRIVAL', 'DEPARTURE'
            else:
                DEPARTURE, ARRIVAL = 'DEPARTURE', 'ARRIVAL'

            # Create string of all Frequencies
            ATC_FREQUENCIES = create_freq_list_combined(DEPARTURE)
            ATC_TOWER_FREQ, ATC_TOWER_NAME = get_ATC_TOWER(DEPARTURE)

            # Prepare HTML content data
            empty_field = '[ . . . . . . . . . ]'
            html_content = {
                'CALLSIGN': flight_data.get('CALLSIGN', '') or empty_field,
                'CALLSIGN_SHORT': flight_data.get('CALLSIGN_SHORT', '') or empty_field,
                'AIRCRAFT_TYPE': flight_data.get('AIRCRAFT_TYPE', '') or empty_field,
                'FLIGHT_RULES': flight_data.get('FLIGHT_RULES', ''),
                'POB': flight_data.get('POB', '') or empty_field,

                'ARRIVAL_NAME': flight_data.get(f'{ARRIVAL}_NAME', '') or empty_field,
                'ARRIVAL_RUNWAY': flight_data.get(f'{ARRIVAL}_RUNWAY', '') or empty_field,
                'ARRIVAL_ROUTE_ALTITUDE': str(flight_data.get(f'{ARRIVAL}_ROUTE_ALTITUDE', '')) or empty_field,
                'ARRIVAL_ICAO': flight_data.get(f'{ARRIVAL}_ICAO', '') or empty_field,

                'CTR_REGION_BOOL': 'true' if flight_data.get(f'{DEPARTURE}_CTR', False) else 'false',
                'DEPARTURE_POSITION': flight_data.get(f'{DEPARTURE}_POSITION', '') or 'at the Apron',
                'DEPARTURE_RUNWAY': flight_data.get(f'{DEPARTURE}_RUNWAY', '') or empty_field,
                'DEPARTURE_NAME': flight_data.get(f'{DEPARTURE}_NAME', '') or empty_field,
                'DEPARTURE_ROUTE_NAME': flight_data.get(f'{DEPARTURE}_ROUTE_NAME', '') or empty_field,
                'DEPARTURE_ROUTE_ALTITUDE': flight_data.get(f'{DEPARTURE}_ROUTE_ALTITUDE', '') or empty_field,
                'DEPARTURE_CITY_ICAO': flight_data.get(f'{DEPARTURE}_NAME', '') or empty_field,
                'DEPARTURE_ICAO': flight_data.get(f'{DEPARTURE}_ICAO', '') or empty_field,

                'ATC_TOWER': ATC_TOWER_FREQ,
                'ATC_ATIS_FREQ_DEP': flight_data.get(f'{DEPARTURE}_ATC_ATIS_FREQ', ''),
                'DELIVERY_OR_RADIO': ATC_TOWER_NAME if ATC_TOWER_NAME == 'RADIO' else 'DELIVERY',
                'ATC_GROUND': ATC_TOWER_FREQ if ATC_TOWER_NAME == 'RADIO' else flight_data.get(f'{DEPARTURE}_ATC_GROUND', ''),
                'ATC_FREQUENCIES': ATC_FREQUENCIES,

                'GRID_COLUMNS': settings.get('user_select_cols', 1),
            }

            # Prepare CSS content
            fontsizes = settings.get('fontsizes')
            css_content = {
                'FONT_SIZE_TOWER': fontsizes.get('TOWER'),
                'FONT_SIZE_PILOT': fontsizes.get('PILOT'),
                'FONT_SIZE_TITLE': fontsizes.get('TITLE'),
                'FONT_SIZE_SUBTITLE': fontsizes.get('TITLE') - 2,
                'BACKGROUND_COLOR_TITLE': '#4769b1',
            }

            html_string = await personalize_content(html_content, 'ATC_departure_template.html.j2')
            css_string = await personalize_content(css_content, 'style_template.css.j2')

            # Embed CSS in the HTML content
            html_with_css = f"""
            <style>
            {css_string}
            </style>
            {html_string}
            """

            return html_with_css

        except Exception as e:
            return f"<p>Error generating Deparature HTML: {str(e)}</p>"


    async def generate_arrival_html(reverse_path=False):
        """Generate HTML content for arrivak screen similar to ATC_ARRIVAL."""

        flight_data = js.window.flight_plan_data
        settings = js.window.settings

        try:
            # Set departure and arrival
            if reverse_path:
                DEPARTURE, ARRIVAL = 'ARRIVAL', 'DEPARTURE'
            else:
                DEPARTURE, ARRIVAL = 'DEPARTURE', 'ARRIVAL'

            # Create string of all Frequencies
            ATC_FREQUENCIES = create_freq_list_combined(ARRIVAL)
            ATC_TOWER_FREQ, ATC_TOWER_NAME = get_ATC_TOWER(ARRIVAL)

            # Set the content to customize the html
            empty_field = '[ . . . . . . . . . ]'
            html_content = {
                'AIRCRAFT_TYPE': flight_data.get('AIRCRAFT_TYPE', '') or empty_field,
                'CALLSIGN': flight_data.get('CALLSIGN', '') or empty_field,
                'CALLSIGN_SHORT': flight_data.get('CALLSIGN_SHORT', '') or empty_field,
                'FLIGHT_RULES': flight_data.get('FLIGHT_RULES', '') or empty_field,
                'CIRCUIT_ALTITUDE': flight_data.get('CIRCUIT_ALTITUDE', '') or empty_field,
                'ARRIVAL_CITY_ICAO': flight_data.get(f'{ARRIVAL}_ICAO', '') or empty_field,
                'POB': flight_data.get('POB', '') or empty_field,

                'ARRIVAL_NAME': flight_data.get(f'{ARRIVAL}_NAME', '') or empty_field,
                'ARRIVAL_RUNWAY': flight_data.get(f'{ARRIVAL}_RUNWAY', '') or empty_field,
                'ARRIVAL_ROUTE_NAME': flight_data.get(f'{ARRIVAL}_ROUTE_NAME', '') or empty_field,
                'ARRIVAL_ROUTE_ALTITUDE': flight_data.get(f'{ARRIVAL}_ROUTE_ALTITUDE', '') or empty_field,

                'DEPARTURE_ICAO': flight_data.get(f'{DEPARTURE}_ICAO', '') or empty_field,
                'ARRIVAL_ICAO': flight_data.get(f'{ARRIVAL}_ICAO', '') or empty_field,

                'REQUEST_INFORMATION': '' if flight_data.get(f'{ARRIVAL}_CTR', False) else 'REQUEST AERODROME INFORMATION',
                'TEXT_INFORMATION_RECEIVED': TEXT_INFORMATION_RECEIVED() if flight_data.get(f'{ARRIVAL}_CTR', False) else '',

                'ATC_TOWER_NAME': ATC_TOWER_NAME,
                'ATC_TOWER': ATC_TOWER_FREQ,
                'ATC_FREQUENCIES': ATC_FREQUENCIES,
                'GRID_COLUMNS': settings.get('user_select_cols', 1),
            }

            # Prepare CSS content
            fontsizes = settings.get('fontsizes')
            css_content = {
                'FONT_SIZE_TOWER': fontsizes.get('TOWER'),
                'FONT_SIZE_PILOT': fontsizes.get('PILOT'),
                'FONT_SIZE_TITLE': fontsizes.get('TITLE'),
                'FONT_SIZE_SUBTITLE': fontsizes.get('TITLE') - 2,
                'BACKGROUND_COLOR_TITLE': '#258f45',
            }

            # Personalize the html based on the departure and aircraft
            html_string = await personalize_content(html_content, 'ATC_arrival_template.html.j2')
            css_string = await personalize_content(css_content, 'style_template.css.j2')

            # Embed CSS in the HTML content
            html_with_css = f"""
            <style>
            {css_string}
            </style>
            {html_string}
            """

            return html_with_css

        except Exception as e:
            return f"<p>Error generating HTML: {str(e)}</p>"


    async def generate_enroute_html(reverse_path=False):
        """Generate HTML content for enroute screen similar to ATC_ENROUTE."""

        flight_data = js.window.flight_plan_data
        settings = js.window.settings

        try:
            # Set departure and arrival
            if reverse_path:
                DEPARTURE, ARRIVAL = 'ARRIVAL', 'DEPARTURE'
            else:
                DEPARTURE, ARRIVAL = 'DEPARTURE', 'ARRIVAL'

            # Prepare HTML content data (adjust keys as needed)
            empty_field = '[ . . . . . . . . . ]'
            html_content = {
                'AIRCRAFT_TYPE': flight_data.get('AIRCRAFT_TYPE', '') or empty_field,
                'CALLSIGN': flight_data.get('CALLSIGN', '') or empty_field,
                'CALLSIGN_SHORT': flight_data.get('CALLSIGN_SHORT', '') or empty_field,

                'FIC_NAME': flight_data.get('FIC_NAME', '') or empty_field,
                'FIC_FREQUENCY': flight_data.get('FIC_FREQUENCY', ''),
                'FIC_SQUAWK': flight_data.get('SQUAWK', ''),
                'FIC_SQUAWK2': flight_data.get('SQUAWK2', ''),

                'OVERHEAD': flight_data.get('OVERHEAD', flight_data.get(f'{DEPARTURE}_ROUTE_NAME', '') or empty_field),
                'OVERHEAD2': flight_data.get('OVERHEAD2', '') or empty_field,
                'FLIGHT_RULES': flight_data.get('FLIGHT_RULES', ''),
                'POB': flight_data.get('POB', '') or empty_field,

                'DEPARTURE_ICAO': flight_data.get(f'{DEPARTURE}_ICAO', '') or empty_field,
                'DEPARTURE_NAME': flight_data.get(f'{DEPARTURE}_NAME', '') or empty_field,
                'DEPARTURE_ROUTE_ALTITUDE': flight_data.get(f'{DEPARTURE}_ROUTE_ALTITUDE', '') or empty_field,

                'ARRIVAL_ICAO': flight_data.get(f'{ARRIVAL}_ICAO', '') or empty_field,
                'ARRIVAL_NAME': flight_data.get(f'{ARRIVAL}_NAME', '') or empty_field,
                'ATC_FREQUENCIES': create_freq_list_combined([DEPARTURE, ARRIVAL]),
                'GRID_COLUMNS': settings.get('user_select_cols', 1),
            }

            if reverse_path:
                html_content['FIC_NAME'] = flight_data.get('FIC_NAME2', '') or empty_field
                html_content['FIC_FREQUENCY'] = flight_data.get('FIC_FREQUENCY2', '')
                html_content['OVERHEAD'] = flight_data.get('OVERHEAD2', '')
                html_content['FIC_SQUAWK'] = flight_data.get('SQUAWK2', '')

            fontsizes = settings.get('fontsizes')
            css_content = {
                'FONT_SIZE_TOWER': fontsizes.get('TOWER'),
                'FONT_SIZE_PILOT': fontsizes.get('PILOT'),
                'FONT_SIZE_TITLE': fontsizes.get('TITLE'),
                'FONT_SIZE_SUBTITLE': fontsizes.get('TITLE') - 2,
                'BACKGROUND_COLOR_TITLE': '#ec7d15',
            }
            html_string = await personalize_content(html_content, 'ATC_enroute_template.html.j2')
            css_string = await personalize_content(css_content, 'style_template.css.j2')
            html_with_css = f"""
            <style>
            {css_string}
            </style>
            {html_string}
            """
            return html_with_css
        except Exception as e:
            return f"<p>Error generating HTML: {str(e)}</p>"


    def get_ATC_TOWER(fname):
        """Get ATC tower frequency and name for DEPARTURE or ARRIVAL from flight_plan_data."""
        data = js.window.flight_plan_data

        if fname=='DEPARTURE':
            ATC_TOWER_FREQ = data.get('DEPARTURE_ATC_TOWER', '')
            ATC_TOWER_FREQ = ATC_TOWER_FREQ if ATC_TOWER_FREQ not in (None, '') else '???.???'
            ATC_TOWER_NAME = 'TOWER' if data.get('DEPARTURE_CTR') else 'RADIO'
        elif fname=='ARRIVAL':
            ATC_TOWER_FREQ = data.get('ARRIVAL_ATC_TOWER', '')
            ATC_TOWER_FREQ = ATC_TOWER_FREQ if ATC_TOWER_FREQ not in (None, '') else '???.???'
            ATC_TOWER_NAME = 'TOWER' if data.get('ARRIVAL_CTR') else 'RADIO'

        return ATC_TOWER_FREQ, ATC_TOWER_NAME


    def set_fontsizes(params):
        user_usage_type = str(params.user_usage_type if hasattr(params, 'user_usage_type') else 'view')
        user_select_cols = str(params.user_select_cols if hasattr(params, 'user_select_cols') else '1')
        # Change fontsize based on settings
        if 'view' in user_usage_type.lower() and user_select_cols == '1':
            fontsizes = {'TOWER': 14, 'PILOT': 16, 'TITLE': 20}
        elif 'view' in user_usage_type.lower() and (user_select_cols == '2' or user_select_cols == '3'):
            fontsizes = {'TOWER': 12, 'PILOT': 14, 'TITLE': 14}
        elif 'print' in user_usage_type.lower() and (user_select_cols == '2' or user_select_cols == '3'):
            fontsizes = {'TOWER': 16, 'PILOT': 18, 'TITLE': 20}
        else:
            fontsizes = {'TOWER': 20, 'PILOT': 22, 'TITLE': 24}
        return fontsizes

    #async def fetch_and_cache_template(url, template_key):


    async def load_template(template_name):
        """Fetch from URL, store in localStorage, and return text content."""
        template_key = f"template_{template_name}"
        base_url = js.window.settings['html_templates']
        url = os.path.join(base_url, template_name)

        #response =  await fetch_and_cache_template(url, template_key)
        # 1. Try cache
        cached = js.localStorage.getItem(template_key)
        if cached:
            print("‚úÖ Loaded from cache")
            return cached

            # 2. Fetch template using JS fetch
        print(f"üåê Fetching from URL: {url}")

        try:
            response = await js.fetch(url)
            if response.ok:
                content = await response.text()  # get the text content
                js.localStorage.setItem(template_key, content)  # store content
                print(f"‚úÖ Template cached under key '{template_key}'")
                return content
            else:
                print(f"‚ùå Fetch failed: {response.status}")
                return None
        except Exception as e:
            print(f"‚ùå Error fetching template: {e}")
            return None


    async def personalize_content(content, template_name):
        # Load template content (async)
        template_content = await load_template(template_name)

        # Use DictLoader to store template
        jinja_env = Environment(loader=DictLoader({template_name: template_content}))

        try:
            template = jinja_env.get_template(template_name)
            html_content = template.render(content)
            return html_content
        except Exception as e:
            return f"<p>Error generating HTML: {e}</p>"


    def open_html(html_content, pagename="_blank"):
        logger.info('open_in_browser(html_content)')

        # Inject viewport for mobile if not present
        if "<head>" in html_content and 'name="viewport"' not in html_content:
            html_content = html_content.replace(
                "<head>",
                '<head><meta name="viewport" content="width=device-width, initial-scale=1.0">'
            )
        elif "<head>" not in html_content:
            html_content = (
                '<meta name="viewport" content="width=device-width, initial-scale=1.0">'
                + html_content
            )

        # new_win = window.open("", "_blank")
        new_win = window.open("", pagename)
        if not new_win:
            # blocked
            window.alert("Popup blocked. Try allowing popups for this site.")
            return
        new_win.document.write(html_content)
        new_win.document.close()

    # %%
    def create_freq_list_combined(fname):
        """Create ATC frequency list for both DEPARTURE and ARRIVAL using flight_plan_data."""
        if isinstance(fname, str): fname = [fname]

        data = js.window.flight_plan_data
        settings = js.window.settings
        html_string = ''

        def freq_block(freq, label, city):
            if freq:
                return f'''
                <div style="display: grid; grid-template-columns: 1.5fr 3.5fr;">
                    <p class="pilot_general"><strong>{freq}: </strong></p>
                    <p class="pilot_general">{city} {label}</p>
                </div>
                '''
            return ''

        # DEPARTURE frequencies
        if 'DEPARTURE' in fname:
            dep_city = data.get('DEPARTURE_NAME', '')
            html_string += freq_block(data.get('DEPARTURE_ATC_ATIS_FREQ', ''), 'ATIS', dep_city)
            html_string += freq_block(data.get('DEPARTURE_ATC_GROUND', ''), 'DELIVERY/GROUND', dep_city)
            html_string += freq_block(data.get('DEPARTURE_ATC_TOWER', ''), 'TOWER', dep_city)
            html_string += freq_block(data.get('DEPARTURE_ATC_APPROACH', ''), 'APPROACH', dep_city)
            html_string += freq_block(data.get('DEPARTURE_ATC_TELEPHONE', ''), 'TELEPHONE', dep_city)
            #html_string += freq_block(data.get('DELIVERY_OR_RADIO', ''), 'RADIO', dep_city)

        # Add a horizontal rule between departure and arrival
        if len(fname)>=2:
            html_string += '<hr>'

        # ARRIVAL frequencies
        if 'ARRIVAL' in fname:
            arr_city = data.get('ARRIVAL_NAME', '')
            html_string += freq_block(data.get('ARRIVAL_ATC_ATIS_FREQ', ''), 'ATIS', arr_city)
            html_string += freq_block(data.get('ARRIVAL_ATC_GROUND', ''), 'DELIVERY/GROUND', arr_city)
            html_string += freq_block(data.get('ARRIVAL_ATC_TOWER', ''), 'TOWER', arr_city)
            html_string += freq_block(data.get('ARRIVAL_ATC_APPROACH', ''), 'APPROACH', arr_city)
            html_string += freq_block(data.get('ARRIVAL_ATC_TELEPHONE', ''), 'TELEPHONE', arr_city)
            #html_string += freq_block(data.get('DELIVERY_OR_RADIO_ARR', ''), 'RADIO', arr_city)

        html_string += '<hr>'
        SQUAWK = f": {data.get('SQUAWK', '')}" if data.get('SQUAWK', '') else ''
        SQUAWK2 = f": {data.get('SQUAWK2', '')}" if data.get('SQUAWK2', '') else ''
        html_string += freq_block(data.get('FIC_FREQUENCY', '') , data.get('FIC_NAME', '') + SQUAWK, '')
        html_string += freq_block(data.get('FIC_FREQUENCY2', '') , data.get('FIC_NAME2', '') + SQUAWK2, '')

        return html_string


    async def retrieve_metar(fname):
        """Retrieve METAR data for given fname"""
        logger.info(f"func: retrieve_metar() - {fname}")

        # Get data
        flight_plan_data = js.window.flight_plan_data
        SETTINGS = js.window.settings

        # Gather METAR data and compute
        fname_METAR = f"{fname}_METAR"
        fname_RUNWAYS = f"{fname}_RUNWAYS"
        fname_LATLON = f"{fname}_LATLON"
        fname_ICAO = f"{fname}_ICAO"

        # filter_on_country = flight_plan_data[f'{fname}_COUNTRY']
        ICAO = flight_plan_data[fname_ICAO]
        if not ICAO:
            print("‚ö†Ô∏è No ICAO code provided")
            return None

        # Load METAR stations data
        zip_bytes = await load_cached_zip("metar_stations", url=SETTINGS["METAR_stations"])
        if not zip_bytes:
            print("‚ùå Failed to load METAR stations data")
            return None

        if zip_bytes:
            df = extract_csv_from_zip(zip_bytes)
            js.console.log(f"‚úÖ metar_stations loaded: {len(df)} rows.")
            print(f"‚úÖ Successfully loaded {len(df)} aerodromes for {metar_stations}")
        return None

        if ICAO == "":
            logger.warning(f"Set the ICAO Aerodrome first.")
            show_popup("Select Aerodrome", "Please select an aerodrome first.")
            return

        # Retrieve runways
        rwy_list = flight_plan_data.get(fname_RUNWAYS)
        if rwy_list == "" or rwy_list is None or len(rwy_list) == 0:
            _, rwy_list = self.retrieve_runways(
                flight_plan_data[fname_ICAO], colname="icao"
            )
            flight_plan_data.update({fname_RUNWAYS: rwy_list})

        # Retrieve only the valid METAR stations
        # METAR_STATIONS_VALID = metar_info.filter_valid_metar_stations(load_stations=True)

        # Get top n closest metar stations
        lat, lon = flight_plan_data[fname_LATLON]
        closest_metar_stations = metar_info.sort_on_distance_icao_to_metar_stations(
            fname=None,
            return_col="icao",
            lat=lat,
            lon=lon,
            filter_on_country=None,
            n=25,
            source=source,
            ui_type="kivy",
        )
        logger.info(
            f"Retrieve closest METAR data for {ICAO} in {fname_METAR} which is {closest_metar_stations[0]}"
        )

        # Retrieve Metar observations
        for icao in closest_metar_stations:
            METAR_DATA = metar_info.get_metar(icao)
            if METAR_DATA is not None:
                METAR_ICAO = icao
                break
            else:
                logger.info(f"{icao} was not valid. Trying another METAR station.")
                METAR_ICAO = ""
                METAR_DATA = {}
                time.sleep(0.2)

        # # Add METAR data to flightplan data. The dict needs to be updated first because it is required in the runway prediction hereafter.
        # flight_plan_data.update({
        #     fname_METAR: METAR_DATA,
        #     f'{self.fname}_METAR_ICAO': METAR_ICAO,
        #     })

        # Predict the runway number based on the METAR data
        METAR_DATA["RUNWAYS"] = flight_plan_data.get(f"{self.fname}_RUNWAYS", [])
        RUNWAY_PREDICTED = compute.expected_runway_number(
            self.fname, data=METAR_DATA, ui_type="kivy"
        )
        if RUNWAY_PREDICTED == "":
            logger.warning(f"No runway predicted. Please check the METAR data.")
            show_popup(
                "Runway unknown with variable (VRB) wind",
                "Runway needs to be set manually.\nPlease check the METAR data.",
            )
        else:
            # Refresh the GUI fields. Do not update all others because it will any custom user input because it is not yet stored.
            self.RUNWAY_input.text = RUNWAY_PREDICTED

        # Display METAR data based on checkbox state (raw or decoded)
        if self.METAR_decoded_checkbox.active:
            self.METAR_input.text = str(METAR_DATA.get("decoded", ""))
        else:
            self.METAR_input.text = str(METAR_DATA.get("metar", ""))

        self.METAR_DATETIME.text = (
            str(METAR_DATA.get("datetime", ""))
            if METAR_DATA.get("datetime") is not None
            else ""
        )
        self.TAF_input.text = (
            str(METAR_DATA.get("TAF", "")) if METAR_DATA.get("TAF") is not None else ""
        )

        # Populate wind input fields with METAR data
        if "wind" in METAR_DATA and METAR_DATA["wind"]:
            wind_data = METAR_DATA.get("wind", {})
            # Format wind direction as three digits with leading zeros
            self.wind_direction_input.text = format_wind_direction(
                wind_data.get("direction")
            )
            self.wind_speed_input.text = str(wind_data.get("speed") or "")
            self.wind_gust_input.text = str(wind_data.get("gust") or "")
            self.wind_variation_input.text = str(wind_data.get("variation") or "")

            # Compute cross/head wind
            crosswind = compute.crosswind(
                wind_data.get("direction"), wind_data.get("speed"), RUNWAY_PREDICTED
            )
            headwind = compute.headwind(
                wind_data.get("direction"), wind_data.get("speed"), RUNWAY_PREDICTED
            )
            METAR_DATA["wind"]["crosswind"] = (
                round(crosswind, 1) if crosswind is not None else ""
            )
            METAR_DATA["wind"]["headwind"] = (
                round(headwind, 1) if headwind is not None else ""
            )
            self.CROSSWIND_input.text = str(METAR_DATA["wind"]["crosswind"] or "")
            self.HEADWIND_input.text = str(METAR_DATA["wind"]["headwind"] or "")

        # Update flightplan data with the predicted runway
        flight_plan_data.update(
            {
                f"{self.fname}_RUNWAY": RUNWAY_PREDICTED,
                fname_METAR: METAR_DATA,
                f"{self.fname}_METAR_ICAO": METAR_ICAO,
            }
        )

        # Add METAR data to flightplan data. The dict needs to be updated first because it is required in the runway prediction hereafter.
        # flight_plan_data.update({
        #     fname_METAR: METAR_DATA,
        #     f'{self.fname}_METAR_ICAO': METAR_ICAO,
        #     })

        # Compute the wind envelope
        self.compute_wind_envelope()
        self.compute_cloud_plot()


    # =================================================================
    # Make functions available to JavaScript
    js.window.create_new_flightplan = create_new_flightplan
    js.window.load_flightplan = load_flightplan
    js.window.delete_flightplan = delete_flightplan
    js.window.save_flightplan = save_flightplan
    js.window.retrieve_metar = retrieve_metar
    js.window.update_flightplan_list = create_proxy(update_flightplan_list)
    js.window.clear_cache = clear_cache

    # ATC
    js.window.create_summary_atc = create_proxy(create_summary_atc)
    js.window.create_departure_atc = create_proxy(create_departure_atc)
    js.window.create_arrival_atc = create_proxy(create_arrival_atc)
    js.window.create_enroute_atc = create_proxy(create_enroute_atc)

    # HELPERS FOR ATC
    js.window.create_callsign_short = create_proxy(create_callsign_short)
    js.window.import_aerodrome_selected = create_proxy(import_aerodrome_selected)
    js.window.generate_summary_html = create_proxy(generate_summary_html)
    js.window.set_fontsizes = create_proxy(set_fontsizes)

    # GENERAL TAB
    js.window.clear_general_fields = clear_general_fields

    # DEPARTURE/ARRIVAL TAB
    js.window.populate_aerodrome_fields_from_icao = create_proxy(populate_aerodrome_fields_from_icao)
    js.window.update_aerodrome_gui_fields = update_aerodrome_gui_fields
    js.window.clear_aerodrome_fields = clear_aerodrome_fields
    js.window.update_aerodrome_image = update_aerodrome_image
    js.window.clear_aerodrome_image = clear_aerodrome_image
    js.window.cache_and_display_image = cache_and_display_image

    # ENROUTE TAB
    js.window.clear_enroute_fields = clear_enroute_fields

    # DATA FUNCTIONS
    js.window.get_default_data = get_default_data
    js.window.get_default_settings = get_default_settings

    # Load the flightplan list on startup
    update_flightplan_list()
  </script>

  <!-- Vanilla JS for tabs and flightplan buttons -->
  <script>
    const tabButtons = document.querySelectorAll(".tablinks");
    const tabContents = document.querySelectorAll(".tabcontent");

    // Function to check for missing fields and update highlighting
    function updateMissingFields() {
        const inputs = [
          CALLSIGN, AIRCRAFT_TYPE, POB, FLIGHTPLAN,
          DEPARTURE_ATC_GROUND, DEPARTURE_ATC_ATIS_FREQ, DEPARTURE_ATC_TOWER,
          DEPARTURE_ROUTE_ALTITUDE, DEPARTURE_ROUTE_NAME, DEPARTURE_RUNWAY,
          DEPARTURE_POSITION, DEPARTURE_NAME, DEPARTURE_ICAO,
          ARRIVAL_NAME, ARRIVAL_ICAO,
          ARRIVAL_RUNWAY,
          ARRIVAL_ROUTE_NAME, ARRIVAL_ROUTE_ALTITUDE, ARRIVAL_CIRCUIT_ALTITUDE,
          ARRIVAL_ATC_TOWER,
          FIC_NAME, FIC_FREQUENCY, OVERHEAD, SQUAWK,
        ];

        // Reset all backgrounds first
        inputs.forEach(input => input.style.backgroundColor = '');

        const missing = [];
        if (!FLIGHTPLAN.value) { missing.push('Flightplan Name'); FLIGHTPLAN.style.backgroundColor = '#ffeb3b'; }
        if (!CALLSIGN.value) { missing.push('CALLSIGN'); CALLSIGN.style.backgroundColor = '#ffeb3b'; }
        if (!AIRCRAFT_TYPE.value) { missing.push('Aircraft Type'); AIRCRAFT_TYPE.style.backgroundColor = '#ffeb3b'; }
        if (!POB.value) { missing.push('POB'); POB.style.backgroundColor = '#ffeb3b'; }

        if (!DEPARTURE_NAME.value) { missing.push('Aerodrome Name (Dep.)'); DEPARTURE_NAME.style.backgroundColor = '#ffeb3b'; }
        if (!DEPARTURE_ICAO.value) { missing.push('ICAO (Dep.)'); DEPARTURE_ICAO.style.backgroundColor = '#ffeb3b'; }
        if (!DEPARTURE_POSITION.value) { missing.push('Position (Dep.)'); DEPARTURE_POSITION.style.backgroundColor = '#ffeb3b'; }
        if (!DEPARTURE_RUNWAY.value) { missing.push('Runway (Dep.)'); DEPARTURE_RUNWAY.style.backgroundColor = '#ffeb3b'; }
        if (!DEPARTURE_ROUTE_NAME.value) { missing.push('Route Name (Dep.)'); DEPARTURE_ROUTE_NAME.style.backgroundColor = '#ffeb3b'; }
        if (!DEPARTURE_ROUTE_ALTITUDE.value) { missing.push('Route Altitude (Dep.)'); DEPARTURE_ROUTE_ALTITUDE.style.backgroundColor = '#ffeb3b'; }
        if (!DEPARTURE_ATC_TOWER.value) { missing.push('Freq. Tower/Radio (Dep.)'); DEPARTURE_ATC_TOWER.style.backgroundColor = '#ffeb3b'; }
        if (DEPARTURE_CTR.value === 'CTR') {
            if (!DEPARTURE_ATC_ATIS_FREQ.value) { missing.push('Freq. ATIS (Dep.)'); DEPARTURE_ATC_ATIS_FREQ.style.backgroundColor = '#ffeb3b'; }
            if (!DEPARTURE_ATC_GROUND.value) { missing.push('Freq. Delivery/Ground (Dep.)'); DEPARTURE_ATC_GROUND.style.backgroundColor = '#ffeb3b'; }
        }

        if (!ARRIVAL_NAME.value) { missing.push('Aerodrome Name (Arr.)'); ARRIVAL_NAME.style.backgroundColor = '#ffeb3b'; }
        if (!ARRIVAL_ICAO.value) { missing.push('ICAO (Arr.)'); ARRIVAL_ICAO.style.backgroundColor = '#ffeb3b'; }
        if (!ARRIVAL_RUNWAY.value) { missing.push('Runway (Arr.)'); ARRIVAL_RUNWAY.style.backgroundColor = '#ffeb3b'; }
        if (!ARRIVAL_ROUTE_NAME.value) { missing.push('Route Name (Arr.)'); ARRIVAL_ROUTE_NAME.style.backgroundColor = '#ffeb3b'; }
        if (!ARRIVAL_ROUTE_ALTITUDE.value) { missing.push('Route Altitude (Arr.)'); ARRIVAL_ROUTE_ALTITUDE.style.backgroundColor = '#ffeb3b'; }
        if (!ARRIVAL_CIRCUIT_ALTITUDE.value) { missing.push('Route Altitude (Arr.)'); ARRIVAL_CIRCUIT_ALTITUDE.style.backgroundColor = '#ffeb3b'; }
        if (!ARRIVAL_ATC_TOWER.value) { missing.push('Freq. Tower/Radio (Arr.)'); ARRIVAL_ATC_TOWER.style.backgroundColor = '#ffeb3b'; }

        if (!FIC_NAME.value) { missing.push('FIC name'); FIC_NAME.style.backgroundColor = '#ffeb3b'; }
        if (!FIC_FREQUENCY.value) { missing.push('FIC Freq.'); FIC_FREQUENCY.style.backgroundColor = '#ffeb3b'; }
        if (!OVERHEAD.value) { missing.push('Overhead point.'); OVERHEAD.style.backgroundColor = '#ffeb3b'; }
        if (!SQUAWK.value) { missing.push('SQUAWK.'); SQUAWK.style.backgroundColor = '#ffeb3b'; }

        missing_label.textContent = missing.length ? 'Missing: ' + missing.join(', ') : 'All fields are OK! Create your ATC now.';
    }

    // Function to replace INFORMATION with INFO in input fields
    function updateEnrouteFields() {
        document.querySelectorAll('.REPLACE_INFO').forEach(input => {
            if (input.value) {
                input.value = input.value.toUpperCase().replace(/INFORMATION/g, 'INFO');
            }
        });
    }

    tabButtons.forEach(btn => {
      btn.addEventListener("click", async () => {
        // Get the tab we're switching TO
        const targetTab = btn.getAttribute("data-tab");

        // Get the CURRENT active tab (before switching)
        const currentActiveTab = document.querySelector(".tablinks.active");
        const currentTab = currentActiveTab ? currentActiveTab.getAttribute("data-tab") : null;

        // Save data when switching tabs
        if (pyscriptReady && window.save_flightplan && currentTab && currentTab !== targetTab) {
          try {
            await window.save_flightplan();
          } catch (error) {
            console.error("Error saving data before tab switch:", error);
          }
        }

        // Switch tabs
        tabButtons.forEach(b => b.classList.remove("active"));
        tabContents.forEach(c => c.style.display = "none");
        btn.classList.add("active");
        document.getElementById(btn.getAttribute("data-tab")).style.display = "block";

        // Update INFO fields and check missing fields after tab switch
        updateEnrouteFields();
        updateMissingFields();
      });
    });

    // Flightplan elements
    const CALLSIGN = document.getElementById('CALLSIGN');
    const AIRCRAFT_TYPE = document.getElementById('AIRCRAFT_TYPE');
    const POB = document.getElementById('POB');
    const FLIGHTPLAN = document.getElementById('FLIGHTPLAN');
    const DATETIME = document.getElementById('DATETIME');
    const FLIGHT_RULES_spinner = document.getElementById('FLIGHT_RULES_spinner');

    // Create buttons at the START page
    const new_plan_btn = document.getElementById('new_plan_btn');
    const delete_btn = document.getElementById('delete_btn');
    const retrieve_metar_btn = document.getElementById('retrieve_metar_btn');

    // Create buttons to generate ATC at the ATC page
    const BTN_HTML_SUMMARY = document.getElementById('BTN_HTML_SUMMARY');
    const BTN_HTML_SUMMARY_REV = document.getElementById('BTN_HTML_SUMMARY_REV');
    const BTN_HTML_DEPARTURE = document.getElementById('BTN_HTML_DEPARTURE');
    const BTN_HTML_DEPARTURE_REV = document.getElementById('BTN_HTML_DEPARTURE_REV');
    const BTN_HTML_ARRIVAL = document.getElementById('BTN_HTML_ARRIVAL');
    const BTN_HTML_ARRIVAL_REV = document.getElementById('BTN_HTML_ARRIVAL_REV');
    const BTN_HTML_ENROUTE = document.getElementById('BTN_HTML_ENROUTE');
    const BTN_HTML_ENROUTE_REV = document.getElementById('BTN_HTML_ENROUTE_REV');

    // Missing labels
    const missing_label = document.getElementById('missing_label');

    // Uppercase for all fields with class="UPPERCASE_input"
    document.querySelectorAll('.UPPERCASE_input').forEach(input => {
    input.addEventListener('input', () => {
        input.value = input.value.toUpperCase();
        });
    });

    document.querySelectorAll('.REPLACE_INFO').forEach(input => {
        input.addEventListener('input', () => {
            input.value = input.value.toUpperCase().replace(/INFORMATION/g, 'INFO');
            updateMissingFields();
        });
    });


    // Initial calls to handle any existing values
    updateEnrouteFields();
    updateMissingFields();

    // Wait for PyScript to be ready
    let pyscriptReady = false;

    // Check if PyScript is ready
    function checkPyScriptReady() {
      if (typeof window.create_new_flightplan === 'function') {
        pyscriptReady = true;
        console.log("PyScript is ready!");
        window.flight_plan_data = window.get_default_data();
        console.log("Default data is initialized.");
        window.settings = window.get_default_settings()
        console.log("Settings data is initialized.");
        // Hide loading spinner once everything is ready
        document.getElementById('loading-spinner').style.display = 'none';
      }
    }

    // Check periodically for PyScript
    const checkInterval = setInterval(() => {
      checkPyScriptReady();
      if (pyscriptReady) {
        clearInterval(checkInterval);
      }
    }, 100);

    // Connect PyScript functions to button clicks
    new_plan_btn.onclick = async () => {
      try {
        // Check if PyScript is ready
        if (!pyscriptReady) return alert("Please wait, PyScript is still loading...");

        // Clear all input fields and departure fields
        await clear_general_fields();
        DATETIME.value = await window.create_new_flightplan();

        // Store default flight plan data
        window.flight_plan_data = await window.get_default_data();

        // Clear plan spinner selection
        document.getElementById('plan_spinner').value = "";
        // Update missing fields
        updateMissingFields();
        // Show success message to user
        alert("‚úÖ New flightplan created successfully!\n\nAll fields have been cleared and reset to default values.");

      } catch (error) {
        console.error("Error creating new flightplan:", error);
        alert("Error creating new flightplan. Please try again.");
      }
    };

    // Auto-load functionality moved to plan_spinner onChange event
    document.getElementById('plan_spinner').addEventListener('change', async (e) => {
      if (e.target.value && pyscriptReady && window.load_flightplan) {
        try {
          await window.load_flightplan();
          console.log("‚úÖ Flightplan loaded successfully");
          // Update missing fields after loading
          updateMissingFields();
        } catch (error) {
          console.error("Error loading flightplan:", error);
          alert("Error loading flightplan: " + error);
        }
      }
    });

    delete_btn.onclick = async () => {
      if (pyscriptReady && window.delete_flightplan) {
        await window.delete_flightplan();
      }
    };

    // retrieve_metar_btn.onclick = async () => {
    //   if (pyscriptReady && window.retrieve_metar) {
    //     await window.retrieve_metar('DEPARTURE');
    //   }
    // };



    document.getElementById('BTN_HTML_SUMMARY')?.addEventListener('click', () => {
      if (window.create_summary_atc) { window.create_summary_atc(); }
    });
    document.getElementById('BTN_HTML_SUMMARY_REV')?.addEventListener('click', () => {
      if (window.create_summary_atc) { window.create_summary_atc({ reverse_path: true }); }
    });

    document.getElementById('BTN_HTML_DEPARTURE')?.addEventListener('click', () => {
      if (window.create_departure_atc) { window.create_departure_atc(); }
    });
    document.getElementById('BTN_HTML_DEPARTURE_REV')?.addEventListener('click', () => {
      if (window.create_departure_atc) { window.create_departure_atc({ reverse_path: true }); }
    });

    document.getElementById('BTN_HTML_ARRIVAL')?.addEventListener('click', () => {
      if (window.create_arrival_atc) { window.create_arrival_atc(); }
    });
    document.getElementById('BTN_HTML_ARRIVAL_REV')?.addEventListener('click', () => {
      if (window.create_arrival_atc) { window.create_arrival_atc({ reverse_path: true }); }
    });

    document.getElementById('BTN_HTML_ENROUTE')?.addEventListener('click', () => {
      if (window.create_enroute_atc) { window.create_enroute_atc(); }
    });
    document.getElementById('BTN_HTML_EN_REV')?.addEventListener('click', () => {
      if (window.create_enroute_atc) { window.create_enroute_atc({ reverse_path: true }); }
    });

    // Add clear cache button handler
    document.getElementById('clear_cache_btn')?.addEventListener('click', async () => {
        if (!confirm('This will clear all saved (cached) data. Are you sure?')) return;

        const spinner = document.getElementById('loading-spinner');
        const spinnerText = spinner.querySelector('.spinner-text');
        spinnerText.textContent = 'Clearing cache...';
        spinner.style.display = 'flex';

        try {
            if (await window.clear_cache()) {
                alert('Cache cleared successfully! The page will now reload.');
                location.reload();
            } else { alert('Error clearing cache. Please try again.'); }
        } catch (error) {
            alert('Error clearing cache: ' + error);
        } finally {
            spinner.style.display = 'none';
        }
    });

    const inputs = [
      CALLSIGN, AIRCRAFT_TYPE, POB, FLIGHTPLAN,
      DEPARTURE_ATC_TOWER, DEPARTURE_ATC_ATIS_FREQ, DEPARTURE_ATC_GROUND,
      DEPARTURE_ROUTE_ALTITUDE, DEPARTURE_ROUTE_NAME, DEPARTURE_RUNWAY,
      DEPARTURE_POSITION, DEPARTURE_NAME, DEPARTURE_ICAO,
      ARRIVAL_NAME, ARRIVAL_ICAO,
      ARRIVAL_RUNWAY,
      ARRIVAL_ROUTE_NAME, ARRIVAL_ROUTE_ALTITUDE, ARRIVAL_CIRCUIT_ALTITUDE,
      ARRIVAL_ATC_TOWER,
      FIC_NAME, FIC_FREQUENCY, OVERHEAD, SQUAWK,
    ];
      inputs.forEach(input => {
        input.addEventListener('input', () => {
          const missing = [];
          // Reset all backgrounds first
          inputs.forEach(inp => inp.style.backgroundColor = '');

          if (!FLIGHTPLAN.value) { missing.push('Flightplan Name'); FLIGHTPLAN.style.backgroundColor = '#ffeb3b'; }
          if (!CALLSIGN.value) { missing.push('CALLSIGN'); CALLSIGN.style.backgroundColor = '#ffeb3b'; }
          if (!AIRCRAFT_TYPE.value) { missing.push('Aircraft Type'); AIRCRAFT_TYPE.style.backgroundColor = '#ffeb3b'; }
          if (!POB.value) { missing.push('POB'); POB.style.backgroundColor = '#ffeb3b'; }

          if (!DEPARTURE_NAME.value) { missing.push('Aerodrome Name (Dep.)'); DEPARTURE_NAME.style.backgroundColor = '#ffeb3b'; }
          if (!DEPARTURE_ICAO.value) { missing.push('ICAO (Dep.)'); DEPARTURE_ICAO.style.backgroundColor = '#ffeb3b'; }
          if (!DEPARTURE_POSITION.value) { missing.push('Position (Dep.)'); DEPARTURE_POSITION.style.backgroundColor = '#ffeb3b'; }
          if (!DEPARTURE_RUNWAY.value) { missing.push('Runway (Dep.)'); DEPARTURE_RUNWAY.style.backgroundColor = '#ffeb3b'; }
          if (!DEPARTURE_ROUTE_NAME.value) { missing.push('Route Name (Dep.)'); DEPARTURE_ROUTE_NAME.style.backgroundColor = '#ffeb3b'; }
          if (!DEPARTURE_ROUTE_ALTITUDE.value) { missing.push('Route Altitude (Dep.)'); DEPARTURE_ROUTE_ALTITUDE.style.backgroundColor = '#ffeb3b'; }
          if (!DEPARTURE_ATC_TOWER.value) { missing.push('Freq. Tower/Radio (Dep.)'); DEPARTURE_ATC_TOWER.style.backgroundColor = '#ffeb3b'; }
          if (!SQUAWK.value) { missing.push('SQUAWK.'); SQUAWK.style.backgroundColor = '#ffeb3b'; }
          if (DEPARTURE_CTR.value === 'CTR') {
              if (!DEPARTURE_ATC_ATIS_FREQ.value) { missing.push('Freq. ATIS (Dep.)'); DEPARTURE_ATC_ATIS_FREQ.style.backgroundColor = '#ffeb3b'; }
              if (!DEPARTURE_ATC_GROUND.value) { missing.push('Freq. Delivery/Ground (Dep.)'); DEPARTURE_ATC_GROUND.style.backgroundColor = '#ffeb3b'; }
          }

          if (!ARRIVAL_NAME.value) { missing.push('Aerodrome Name (Arr.)'); ARRIVAL_NAME.style.backgroundColor = '#ffeb3b'; }
          if (!ARRIVAL_ICAO.value) { missing.push('ICAO (Arr.)'); ARRIVAL_ICAO.style.backgroundColor = '#ffeb3b'; }
          if (!ARRIVAL_RUNWAY.value) { missing.push('Runway (Arr.)'); ARRIVAL_RUNWAY.style.backgroundColor = '#ffeb3b'; }
          if (!ARRIVAL_ROUTE_NAME.value) { missing.push('Route Name (Arr.)'); ARRIVAL_ROUTE_NAME.style.backgroundColor = '#ffeb3b'; }
          if (!ARRIVAL_ROUTE_ALTITUDE.value) { missing.push('Route Altitude (Arr.)'); ARRIVAL_ROUTE_ALTITUDE.style.backgroundColor = '#ffeb3b'; }
          if (!ARRIVAL_CIRCUIT_ALTITUDE.value) { missing.push('Route Altitude (Arr.)'); ARRIVAL_CIRCUIT_ALTITUDE.style.backgroundColor = '#ffeb3b'; }
          if (!ARRIVAL_ATC_TOWER.value) { missing.push('Freq. Tower/Radio (Arr.)'); ARRIVAL_ATC_TOWER.style.backgroundColor = '#ffeb3b'; }

          if (!FIC_NAME.value) { missing.push('FIC name'); FIC_NAME.style.backgroundColor = '#ffeb3b'; }
          if (!FIC_FREQUENCY.value) { missing.push('FIC Freq.'); FIC_FREQUENCY.style.backgroundColor = '#ffeb3b'; }
          if (!OVERHEAD.value) { missing.push('Overhead point.'); OVERHEAD.style.backgroundColor = '#ffeb3b'; }

          missing_label.textContent = missing.length ? 'Missing: ' + missing.join(', ') : 'All fields are OK! Create your ATC now.';
        });
      });
  </script>

</body>
</html>




<script>
const COUNTRIES_DATA = [
  // Europe
  'Albania', 'Austria', 'Belarus', 'Belgium',
  'Bulgaria', 'Croatia', 'Cyprus', 'Czech Republic', 'Denmark', 'Estonia',
  'Finland', 'France', 'Germany', 'Greece', 'Hungary', 'Iceland', 'Ireland',
  'Italy', 'Latvia', 'Lithuania', 'Luxembourg', 'Malta',
  'Moldova  Republic Of', 'Montenegro', 'Netherlands',
  'Norway', 'Poland', 'Portugal', 'Romania',
  'Slovakia', 'Slovenia', 'Spain', 'Sweden', 'Switzerland', 'Turkey',
  'United Kingdom',

  // Americas (North, Central, South, Caribbean)
  'Brazil', 'Canada', 'Curacao', 'United States',

  // Oceania
  'Australia', 'Fiji', 'Nauru',
  'New Zealand', 'Palau', 'Papua New Guinea',
];

  /**
   * Generic function to populate a dropdown with data
   * @param {string} selectId - The ID of the select element to populate
   * @param {Array} dataArray - Array of items to populate the dropdown with
   */
  function populateDropdown(selectId, dataArray) {
    const select = document.getElementById(selectId);
    if (!select) {
      console.warn(`Select element with ID '${selectId}' not found`);
      return;
    }
    dataArray.forEach(item => {
      const option = document.createElement('option');
      option.value = item;
      option.textContent = item;
      select.appendChild(option);
    });
  }
</script>


<script>
    function initializeAerodromeFields(fname) {
        // Populate dropdown on page load
        window.addEventListener('DOMContentLoaded', () => {
            populateDropdown(`${fname}_COUNTRY`, COUNTRIES_DATA);
        });

        // Download the aerodrome data when the country changes
        document.getElementById(`${fname}_COUNTRY`).addEventListener("change", async function() {
            const country = this.value;
            if (country && window.import_aerodrome_selected) {
                const spinner = document.getElementById('loading-spinner');
                const spinnerText = spinner.querySelector('.spinner-text');
                spinnerText.textContent = `Loading aerodrome data for ${country}...`;
                spinner.style.display = 'flex';
                document.body.style.cursor = 'wait';
                document.body.style.overflow = 'hidden';  // Prevent scrolling while loading
                try {
                    await window.import_aerodrome_selected(fname, country);
                } catch (error) {
                    console.error("Error importing aerodrome data:", error);
                    alert("Error loading aerodrome data. Please try again.");
                } finally {
                    spinner.style.display = 'none';
                    document.body.style.cursor = '';
                    document.body.style.overflow = '';  // Restore scrolling
                }
            }
        });

        // Populate fields when ICAO city is selected
        document.getElementById(`${fname}_ICAO_CITY`).addEventListener("change", async function() {
            const city_icao = this.value;

            // Clear all aerodrome fields first to prevent data leakage
            if (window.clear_aerodrome_fields) {
                await window.clear_aerodrome_fields(fname);
            }
            // Clear all enroute fields first to prevent data leakage
            if (fname === 'DEPARTURE' && window.clear_enroute_fields) {
                await window.clear_enroute_fields();
            }

            if (city_icao && window.populate_aerodrome_fields_from_icao) {
                // Call PyScript function to populate fields
                await window.populate_aerodrome_fields_from_icao(fname, city_icao);
                // Set CTR to true for departure city selection
                if (fname === 'DEPARTURE') {
                    document.getElementById('DEPARTURE_CTR').value = 'CTR';
                }
                // Update missing fields
                updateMissingFields();
            }
        });

        // Auto-save aerodrome data when fields change
        const fields = [
            `${fname}_COUNTRY`, `${fname}_ICAO_CITY`, `${fname}_CTR`,
            `${fname}_NAME`, `${fname}_ICAO`, `${fname}_POSITION`,
            `${fname}_RUNWAY`, `${fname}_ELEVATION`, `${fname}_ROUTE_NAME`,
            `${fname}_ROUTE_ALTITUDE`, `${fname}_CIRCUIT_ALTITUDE`,
            `${fname}_ATC_TOWER`, `${fname}_ATC_APPROACH`,
            `${fname}_ATC_ATIS_FREQ`, `${fname}_ATC_GROUND`,
            `${fname}_ATC_TELEPHONE`
        ];

        fields.forEach(fieldId => {
            const element = document.getElementById(fieldId);
            if (element) {
                element.addEventListener('change', () => {
                    if (window.flight_plan_data) {
                        window.flight_plan_data[fieldId] = element.value;
                        console.log(`Updated ${fieldId}:`, element.value);
                    }
                });
            }
        });
    }
    // Initialize with DEPARTURE
    initializeAerodromeFields('DEPARTURE');
    initializeAerodromeFields('ARRIVAL');

</script>
